<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ASA Devs | Portal</title>
    <meta name="description" content="Official Training and Placement Portal.">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ASA Devs Portal">
    <link rel="icon" type="image/png" href="logo1.png">
    <link rel="apple-touch-icon" href="logo1.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'], heading: ['Outfit', 'sans-serif'] },
                    animation: { 'fade-up': 'fadeUp 0.4s ease-out forwards' },
                    keyframes: { fadeUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .section-view { display: none; }
        .section-view.active { display: block; animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .admin-control, .admin-view-only { display: none !important; }
        body.is-admin .admin-control { display: inline-flex !important; }
        body.is-admin .admin-view-only { display: grid !important; }
        body.is-admin .student-view-only { display: none !important; }
        [contenteditable="true"]:focus { outline: 2px solid #2563eb; background: rgba(37, 99, 235, 0.05); }
        .a4-page { width: 210mm; min-height: 297mm; background: white; margin: 0 auto; display: flex; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        #global-loader { display: flex; }
        #global-loader.hidden { display: none; }
        
        /* Stats Tabs */
        .stat-tab-btn { transition: all 0.2s; }
        .stat-tab-btn:hover { background: rgba(0,0,0,0.02); }
        
        /* Scanner Overlay Animation */
        .scan-line { width: 100%; height: 3px; background: #ef4444; position: absolute; animation: scan 2.5s infinite linear; top: 0; box-shadow: 0 0 4px red; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        
        /* UI Polish */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .card-3d { perspective: 1000px; transition: transform 0.3s cubic-bezier(0.23, 1, 0.320, 1); }
        .card-3d:hover { transform: translateY(-5px) scale(1.01); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        /* SCANNER MODE - Complete UI Lockdown */
        body.scanner-mode { overflow: hidden !important; }
        body.scanner-mode #app-interface { display: none !important; visibility: hidden !important; }
        body.scanner-mode #mobile-menu { display: none !important; visibility: hidden !important; }
        body.scanner-mode #auth-view { display: none !important; visibility: hidden !important; }
        body.scanner-mode #scanner-interface { display: flex !important; visibility: visible !important; }
        body.scanner-mode * { pointer-events: none; }
        body.scanner-mode #scanner-interface, body.scanner-mode #scanner-interface * { pointer-events: auto; }
        
        /* User-Friendly UI Polish */
        .action-blur {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        
        .btn-tap { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-tap:active { transform: scale(0.95); filter: brightness(0.9); }
        .info-label { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.025em; margin-bottom: 2px; }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col antialiased relative bg-slate-50">

    <div id="global-loader" class="fixed inset-0 z-[9999] bg-white flex items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>

    <div id="mobile-menu" class="hidden fixed inset-0 z-[300]">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleMobileMenu()"></div>
        <div class="absolute inset-y-0 left-0 w-3/4 max-w-xs bg-slate-900 shadow-2xl flex flex-col transition-transform">
            <div class="h-20 flex items-center justify-between px-6 border-b border-white/10">
                <button onclick="navTo('home')" class="flex items-center gap-3 text-white font-bold text-xl"><img src="logo1.png" class="w-8 h-8 object-contain"> ASA Devs.</button>
                <button onclick="toggleMobileMenu()" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
                <button onclick="navTo('home')" class="nav-item active w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard</button>
                
                <button onclick="navTo('monitor')" class="nav-item admin-control w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="activity" class="w-5 h-5 mr-3"></i> Live Monitor</button>
                
                <button onclick="navTo('resources')" class="nav-item w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="folder" class="w-5 h-5 mr-3"></i> Library</button>
                <button onclick="navTo('courses')" class="nav-item w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="book-open" class="w-5 h-5 mr-3"></i> Training</button>
                <button onclick="navTo('placement')" class="nav-item w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="briefcase" class="w-5 h-5 mr-3"></i> Placement</button>
                <button onclick="navTo('events')" class="nav-item w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="calendar" class="w-5 h-5 mr-3"></i> Events</button>
                <button onclick="navTo('activity')" class="nav-item w-full student-view-only flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="activity" class="w-5 h-5 mr-3"></i> Activity</button>
                <button onclick="navTo('profile')" class="nav-item w-full student-view-only flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition mt-4 border-t border-white/10"><i data-lucide="user" class="w-5 h-5 mr-3"></i> Profile</button>
            </nav>
            <div class="p-6 border-t border-white/10 bg-slate-950">
                <button onclick="handleLogout()" class="flex items-center text-red-400 font-bold"><i data-lucide="log-out" class="w-5 h-5 mr-2"></i> Sign Out</button>
            </div>
        </div>
    </div>

    <div id="auth-view" class="fixed inset-0 z-[100] flex bg-transparent">
        <div class="hidden lg:flex lg:w-1/2 bg-slate-900/90 backdrop-blur-xl items-center justify-center flex-col relative overflow-hidden text-white">
            <div class="absolute inset-0 bg-gradient-to-br from-blue-600/20 to-purple-600/20"></div>
            <img src="logo1.png" class="w-32 h-32 object-contain mb-6 animate-fade-up relative z-10">
            <div class="text-center z-10 p-10">
                <h1 class="text-6xl font-bold mb-4 tracking-tight">TSDC.</h1>
                <p class="text-slate-400 text-xl font-light">Training & Placement Portal</p>
            </div>
        </div>
        <div class="w-full lg:w-1/2 flex items-center justify-center p-6 bg-white/60 backdrop-blur-md">
            <div class="w-full max-w-md bg-white/90 p-8 rounded-3xl shadow-2xl border border-white/50">
                
                <div id="role-selector" class="animate-fade-up">
                    <div class="lg:hidden flex justify-center mb-8"><img src="logo1.png" class="w-20 h-20 object-contain"></div>
                    <h2 class="text-3xl font-bold text-slate-900 mb-2 text-center">Welcome</h2>
                    <p class="text-slate-500 mb-8 text-center">Select access level</p>
                    <div class="space-y-4">
                        <button onclick="setAuthMode('student')" class="w-full p-5 border-2 border-slate-100 rounded-2xl hover:border-blue-500 hover:bg-blue-50 transition flex items-center gap-4 group bg-white">
                            <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center"><i data-lucide="graduation-cap"></i></div>
                            <div class="text-left"><h3 class="font-bold text-lg">Student</h3><p class="text-sm text-slate-500">Log in using Roll No</p></div>
                        </button>
                        <button onclick="setAuthMode('admin')" class="w-full p-5 border-2 border-slate-100 rounded-2xl hover:border-slate-800 hover:bg-slate-50 transition flex items-center gap-4 group bg-white">
                            <div class="w-12 h-12 bg-slate-100 text-slate-700 rounded-xl flex items-center justify-center"><i data-lucide="shield"></i></div>
                            <div class="text-left"><h3 class="font-bold text-lg">Faculty / Scanner</h3><p class="text-sm text-slate-500">Log in using Email</p></div>
                        </button>
                        
                        <button onclick="demoAdminLogin()" class="w-full p-3 bg-indigo-50 border border-indigo-200 text-indigo-700 rounded-xl font-bold text-sm hover:bg-indigo-100 transition text-center">
                            Login as Admin (Demo Mode)
                        </button>
                    </div>
                </div>

                <div id="login-form-container" class="hidden animate-fade-up">
                    <button onclick="resetAuth()" class="mb-6 text-sm font-bold text-slate-400 hover:text-slate-800 flex items-center gap-1"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back</button>
                    <h2 class="text-3xl font-bold text-slate-900 mb-2" id="login-title">Login</h2>
                    <p class="text-slate-500 mb-6" id="login-subtitle">Enter credentials</p>
                    <form onsubmit="handleLoginSubmit(event)" class="space-y-4">
                        <input type="hidden" id="login-type">
                        <div>
                            <label class="text-xs font-bold uppercase text-slate-500 block mb-1" id="email-label">ID / Email</label>
                            <input type="text" id="auth-input" class="w-full p-3 bg-white border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition">
                        </div>
                        <div>
                            <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Password</label>
                            <div class="relative">
                                <input type="password" id="auth-pass" class="w-full p-3 pr-12 bg-white border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition">
                                <button type="button" onclick="togglePassword('auth-pass', this)" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 p-1"><i data-lucide="eye" class="w-5 h-5"></i></button>
                            </div>
                        </div>
                        <div id="register-hint" class="text-right hidden"><a href="#" onclick="toggleRegisterMode()" class="text-xs text-blue-600 font-bold hover:underline">New Student? Register</a></div>
                        <div id="login-hint" class="text-right hidden"><a href="#" onclick="toggleRegisterMode()" class="text-xs text-blue-600 font-bold hover:underline">Have account? Login</a></div>
                        <button type="submit" id="auth-btn-text" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl hover:bg-slate-800 transition shadow-lg mt-2">Access Portal</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="app-interface" class="hidden flex h-screen bg-transparent">
        <aside class="hidden md:flex w-64 flex-col bg-slate-900/95 backdrop-blur-xl text-slate-400 h-full fixed z-20 shadow-2xl transition-all duration-300">
            <button onclick="navTo('home')" class="h-20 flex items-center px-6 gap-3 border-b border-white/10 shrink-0 hover:bg-white/5 transition w-full text-left cursor-pointer">
                <img src="logo1.png" class="w-8 h-8 object-contain">
                <span class="text-white font-bold text-xl tracking-tight">ASA Devs.</span>
            </button>
            <nav class="flex-1 px-3 py-6 space-y-1 overflow-y-auto">
                <button id="nav-home" onclick="navTo('home')" class="nav-item active w-full flex items-center px-3 py-3 rounded-lg hover:bg-white/5 hover:text-white transition"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard</button>
                
                <button id="nav-monitor" onclick="navTo('monitor')" class="nav-item admin-control w-full flex items-center px-3 py-3 rounded-lg hover:bg-white/5 hover:text-white transition"><i data-lucide="activity" class="w-5 h-5 mr-3"></i> Live Monitor</button>
                
                <button id="nav-resources" onclick="navTo('resources')" class="nav-item w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="folder" class="w-5 h-5 mr-3"></i> Library</button>
                <button id="nav-courses" onclick="navTo('courses')" class="nav-item w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="book-open" class="w-5 h-5 mr-3"></i> Training</button>
                <button id="nav-placement" onclick="navTo('placement')" class="nav-item w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="briefcase" class="w-5 h-5 mr-3"></i> Placement</button>
                <button id="nav-events" onclick="navTo('events')" class="nav-item w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="calendar" class="w-5 h-5 mr-3"></i> Events</button>
                <button id="nav-activity" onclick="navTo('activity')" class="nav-item w-full student-view-only flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="activity" class="w-5 h-5 mr-3"></i> Activity</button>
                <button onclick="openSupportModal()" class="nav-item w-full student-view-only flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="message-circle" class="w-5 h-5 mr-3"></i> Support</button>
                <button id="nav-profile" onclick="navTo('profile')" class="nav-item w-full student-view-only flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition mt-4 border-t border-white/10"><i data-lucide="user" class="w-5 h-5 mr-3"></i> Profile</button>
            </nav>
            <div class="p-4 border-t border-white/10 shrink-0">
                <div class="flex items-center gap-3 mb-3"><div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xs" id="sb-avatar">U</div><div class="text-sm font-bold text-white truncate" id="sb-name">User</div></div>
                <button onclick="handleLogout()" class="text-xs font-bold text-red-400 hover:text-red-300 w-full text-left">LOGOUT</button>
            </div>
        </aside>

        <main class="flex-1 md:ml-64 flex flex-col h-full overflow-hidden relative bg-slate-50">
            <header class="h-20 bg-white/80 backdrop-blur-md border-b flex items-center justify-between px-6 md:px-10 sticky top-0 z-30 shrink-0">
                <div class="flex items-center gap-3 md:hidden">
                    <button onclick="navTo('home')" class="flex items-center gap-2"><img src="logo1.png" class="w-8 h-8"><span class="font-bold text-xl">ASA Devs.</span></button>
                </div>
                <div class="hidden md:block">
                    <h1 id="header-title" class="text-2xl font-bold text-slate-900">Dashboard</h1>
                    <p id="header-subtitle" class="text-sm text-slate-500 hidden">Manage system</p>
                </div>
                <div class="flex items-center gap-4">
                    <div id="header-action"></div>
                    <button onclick="toggleMobileMenu()" class="md:hidden p-2 bg-slate-100 rounded-lg"><i data-lucide="menu"></i></button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-6 md:p-10 scroll-smooth">
                <div id="home" class="section-view active max-w-6xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4">
                        <div><h1 class="text-3xl font-bold text-slate-900">Hello, <span id="home-name">User</span></h1><p class="text-slate-600" id="home-subtitle">Welcome to your cloud dashboard.</p></div>
                        <span class="admin-view-only bg-slate-900 text-white px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider">Faculty Mode</span>
                    </div>
                    
                    <div class="admin-view-only grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                         <div onclick="navTo('monitor')" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-2xl cursor-pointer hover:shadow-lg transition shadow-blue-200 transform hover:scale-[1.01] active:scale-95">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-lg mb-1">Live Monitor</h3>
                                    <p class="text-blue-100 text-sm">View real-time activity (Grid View)</p>
                                </div>
                                <div class="bg-white/20 p-3 rounded-xl"><i data-lucide="activity"></i></div>
                            </div>
                         </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <button onclick="navTo('resources')" class="stat-card text-left w-full bg-white p-6 rounded-2xl border shadow-sm hover:shadow-md cursor-pointer group"><div class="text-slate-500 text-xs uppercase font-bold group-hover:text-blue-600">Total Resources</div><div class="text-3xl font-bold mt-1 text-slate-900" id="stat-res">--</div></button>
                        <button onclick="navTo('courses')" class="stat-card text-left w-full bg-white p-6 rounded-2xl border shadow-sm hover:shadow-md cursor-pointer group"><div class="text-slate-500 text-xs uppercase font-bold group-hover:text-blue-600">Active Trainings</div><div class="text-3xl font-bold mt-1 text-slate-900" id="stat-course">--</div></button>
                        <button onclick="navTo('placement')" class="stat-card text-left w-full bg-white p-6 rounded-2xl border shadow-sm hover:shadow-md cursor-pointer group"><div class="text-slate-500 text-xs uppercase font-bold group-hover:text-blue-600">Job Postings</div><div class="text-3xl font-bold mt-1 text-slate-900" id="stat-job">--</div></button>
                    </div>
                </div>

                <div id="monitor" class="section-view max-w-6xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Live Student Monitor</h2>
                        <button onclick="refreshLiveStats()" class="bg-white text-blue-600 border border-blue-200 px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-blue-50 flex items-center gap-2"><i data-lucide="refresh-cw" class="w-4 h-4"></i> Refresh</button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white p-5 rounded-2xl border shadow-sm flex items-center justify-between">
                            <div><p class="text-xs font-bold text-slate-500 uppercase">Online</p><h2 class="text-3xl font-bold text-green-600" id="mon-online">0</h2></div>
                            <div class="w-10 h-10 bg-green-50 rounded-full flex items-center justify-center text-green-600"><i data-lucide="wifi"></i></div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl border shadow-sm flex items-center justify-between">
                            <div><p class="text-xs font-bold text-slate-500 uppercase">Total Users</p><h2 class="text-3xl font-bold text-slate-800" id="mon-total">0</h2></div>
                            <div class="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center text-slate-600"><i data-lucide="users"></i></div>
                        </div>
                    </div>

                    <input onkeyup="filterGrid('grid-monitor', this.value)" placeholder="Search students..." class="w-full p-3 border rounded-xl mb-6 bg-white/50 backdrop-blur outline-none focus:ring-2 focus:ring-blue-500">
                    
                    <div id="grid-monitor" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="col-span-full text-center text-slate-400 py-10">Click Refresh to load data...</div>
                    </div>
                </div>

                <div id="resources" class="section-view max-w-6xl mx-auto">
                    <div class="md:hidden flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Library</h2><button onclick="openModal('resources')" class="admin-control bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg">+ Add</button></div>
                    <input onkeyup="filterGrid('grid-resources', this.value)" placeholder="Search resources..." class="w-full p-3 border rounded-xl mb-4 bg-white/50 backdrop-blur outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="grid-resources" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                </div>

                <div id="courses" class="section-view max-w-6xl mx-auto">
                    <div class="md:hidden flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Training</h2><button onclick="openModal('courses')" class="admin-control bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg">+ Add</button></div>
                    <input onkeyup="filterGrid('grid-courses', this.value)" placeholder="Search courses..." class="w-full p-3 border rounded-xl mb-4 bg-white/50 backdrop-blur outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="grid-courses" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                </div>

                <div id="placement" class="section-view max-w-6xl mx-auto">
                    <div class="md:hidden flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Placement</h2><button onclick="openModal('placement')" class="admin-control bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg">+ Add</button></div>
                    <input onkeyup="filterGrid('grid-placement', this.value)" placeholder="Search jobs..." class="w-full p-3 border rounded-xl mb-4 bg-white/50 backdrop-blur outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="grid-placement" class="grid grid-cols-1 gap-3"></div>
                </div>

                <div id="events" class="section-view max-w-6xl mx-auto">
                    <div class="md:hidden flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Events</h2><button onclick="openModal('events')" class="admin-control bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg">+ Add</button></div>
                    <input onkeyup="filterGrid('grid-events', this.value)" placeholder="Search events..." class="w-full p-3 border rounded-xl mb-4 bg-white/50 backdrop-blur outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="grid-events" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                </div>

                <div id="activity" class="section-view max-w-6xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6">My Activity</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-2xl border shadow-sm"><h3 class="font-bold text-lg mb-4 flex items-center"><i data-lucide="ticket" class="w-5 h-5 mr-2 text-blue-600"></i> Event Registrations</h3><div id="my-events-list" class="space-y-3"></div></div>
                        <div class="bg-white p-6 rounded-2xl border shadow-sm"><h3 class="font-bold text-lg mb-4 flex items-center"><i data-lucide="award" class="w-5 h-5 mr-2 text-green-600"></i> Completed Courses</h3><div id="my-courses-list" class="space-y-3"></div></div>
                    </div>
                </div>

                <div id="profile" class="section-view max-w-4xl mx-auto">
                    <div class="bg-white p-8 rounded-2xl border shadow-sm mb-6 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                        <div><h1 class="text-3xl font-bold mb-1" id="prof-name">User</h1><p class="text-slate-500" id="prof-meta">Department • Year</p></div>
                        <button onclick="openResume()" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-slate-800 w-full md:w-auto">Resume Builder</button>
                    </div>
                    <div class="bg-white p-8 rounded-2xl border shadow-sm mb-6"><div class="flex justify-between mb-4"><h3 class="font-bold">Bio</h3><button onclick="openProfileModal()" class="text-blue-600 text-xs font-bold hover:underline">EDIT PROFILE</button></div><p id="prof-bio" class="text-slate-600 p-2">Loading...</p></div>
                </div>
            </div>
        </main>
    </div>

    <div id="data-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4"><div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl animate-fade-up"><div class="flex justify-between mb-4"><h3 class="font-bold text-xl" id="modal-title">Add Item</h3><button onclick="document.getElementById('data-modal').classList.add('hidden')"><i data-lucide="x"></i></button></div><div id="modal-fields" class="space-y-3"></div><input type="file" id="unified-file-input" class="hidden" onchange="handleFileUpload(this)"><button id="modal-save" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl mt-6 hover:bg-blue-700">Save to Cloud</button></div></div>

    <div id="scanner-interface" class="hidden fixed inset-0 z-[5000] bg-black flex flex-col w-screen h-screen">
        <div class="scanner-header h-20 flex items-center justify-between px-6 shrink-0 fixed top-0 w-full z-10 bg-black border-b border-white/10">
            <div class="flex items-center gap-4"><span class="scanner-status-text text-white font-bold text-sm">GATEKEEPER</span></div>
            <button onclick="handleLogout()" class="text-xs font-bold text-red-400 border border-red-400/40 px-4 py-2 rounded-lg">LOGOUT</button>
        </div>
        <div class="fixed top-20 left-0 right-0 bottom-0 flex flex-col relative overflow-hidden bg-black">
            <div id="dedicated-reader" class="w-full h-full object-cover"></div>
            <div id="scan-status-panel" class="absolute bottom-0 inset-x-0 bg-slate-900 p-8 transform transition-transform duration-300 translate-y-full z-20"><h2 id="status-title" class="text-white">Scanning...</h2></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, updateDoc, deleteDoc, query, where, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB0e8-7ohxpLULJ3ZvWtmq9wg99zjDF_js",
            authDomain: "tsdc-portal.firebaseapp.com",
            projectId: "tsdc-portal",
            storageBucket: "tsdc-portal.firebasestorage.app",
            messagingSenderId: "138306273988",
            appId: "1:138306273988:web:dd79c26ae1acf02dee3f91"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let isRegistering = false;
        let activeCertCourseId = null;
        let html5QrcodeScanner = null;
        let dedicatedScanner = null;
        let editingId = null;
        let modalType = null;
        
        window.appData = { resources: [], courses: [], placement: [], events: [] };
        
        const ADMIN_EMAILS = ["master@asadevs.com", "842@asadevs.com", "395@asadevs.com", "617@asadevs.com", "204@asadevs.com", "573@asadevs.com"];
        const SCANNER_EMAILS = ["scanner1@asadevs.com", "scanner2@asadevs.com", "scanner3@asadevs.com"];

        // --- HEARTBEAT SYSTEM (REAL-TIME TRACKING) ---
        const updateHeartbeat = async () => {
            if (currentUser && currentUser.role === 'student') {
                try {
                    const userRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userRef, { 
                        lastSeen: new Date().toISOString()
                    });
                } catch(e) { console.log("Heartbeat silent fail", e); }
            }
        };

        // --- AUTH & LOGIN LOGIC ---
        window.setAuthMode = (mode) => {
            const container = document.getElementById('login-form-container');
            const selector = document.getElementById('role-selector');
            const title = document.getElementById('login-title');
            const sub = document.getElementById('login-subtitle');
            const regHint = document.getElementById('register-hint');
            const emailLabel = document.getElementById('email-label');

            selector.classList.add('hidden');
            container.classList.remove('hidden');
            isRegistering = false;
            document.getElementById('login-hint').classList.add('hidden');
            document.getElementById('auth-btn-text').innerText = "Access Portal";

            if (mode === 'student') {
                title.innerText = "Student Login";
                sub.innerText = "Enter your Student ID";
                emailLabel.innerText = "Student ID";
                regHint.classList.remove('hidden');
                document.getElementById('auth-input').placeholder = "e.g. 202402001";
                document.getElementById('login-type').value = 'student';
            } else {
                title.innerText = "Faculty Login";
                sub.innerText = "Authorized Personnel Only";
                emailLabel.innerText = "Official Email";
                regHint.classList.add('hidden');
                document.getElementById('auth-input').placeholder = "faculty@asadevs.com";
                document.getElementById('login-type').value = 'admin';
            }
        };

        window.resetAuth = () => {
            document.getElementById('login-form-container').classList.add('hidden');
            document.getElementById('role-selector').classList.remove('hidden');
            document.getElementById('auth-input').value = '';
            document.getElementById('auth-pass').value = '';
        };

        window.toggleRegisterMode = () => {
            isRegistering = !isRegistering;
            const title = document.getElementById('login-title');
            const btn = document.getElementById('auth-btn-text');
            const regHint = document.getElementById('register-hint');
            const logHint = document.getElementById('login-hint');

            if (isRegistering) {
                title.innerText = "Student Registration";
                btn.innerText = "Create Account";
                regHint.classList.add('hidden');
                logHint.classList.remove('hidden');
            } else {
                title.innerText = "Student Login";
                btn.innerText = "Access Portal";
                regHint.classList.remove('hidden');
                logHint.classList.add('hidden');
            }
        };

        function isIdAllowed(idStr) {
            const id = parseInt(idStr);
            if (isNaN(id)) return false;
            const bammc = [202310001, 202310003, 202310007, 202310009, 202310010, 202410001, 202410004, 202410005, 202410007, 202410008, 202410009, 202410011, 202410012, 202410014, 202410017, 202410019];
            if (bammc.includes(id)) return true;
            const ranges = [
                [202501001, 202501072], [202401001, 202401073], [202301001, 202301052],
                [202512001, 202512013], [202505001, 202505072], [202505101, 202505172], 
                [2024005001, 2024005072], [2024005101, 2024005171], [202305001, 202305076],
                [202503001, 202503072], [202503101, 202503172], [202403001, 202403074], 
                [202403101, 202403175], [202303001, 202303072], [202303101, 202303136],
                [202513001, 202513024], [202508001, 202508072], [202508101, 202508166], 
                [202408001, 202408160], [202308001, 202308071], [202308103, 202308170], 
                [202308203, 202308251], [202509001, 202509068], [202409001, 202409044], 
                [202309001, 202309022], [202502001, 202502072], [202502101, 202502172], 
                [202502201, 202502260], [202402001, 202402066], [202402101, 202402165], 
                [202402201, 202402266], [202302001, 202302072], [202302101, 202302184]
            ];
            return ranges.some(r => id >= r[0] && id <= r[1]);
        }

        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('global-loader');
            if (user) {
                let role = 'student';
                if (ADMIN_EMAILS.includes(user.email)) role = 'admin';
                if (SCANNER_EMAILS.includes(user.email)) role = 'scanner';

                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    currentUser = { ...docSnap.data(), uid: user.uid, email: user.email, role: role };
                    loginSuccess(currentUser);
                } else {
                    if (role !== 'student') {
                        const profileData = { name: role === 'admin' ? "Faculty Admin" : "Security Officer", dept: "Staff", year: "N/A", bio: "Staff", email: user.email };
                        await setDoc(docRef, profileData);
                        currentUser = { ...profileData, uid: user.uid, role: role };
                        loginSuccess(currentUser);
                    } else {
                        document.getElementById('auth-view').classList.add('hidden');
                        document.getElementById('onboarding-modal').classList.remove('hidden');
                    }
                }
            } else {
                if(dedicatedScanner) { dedicatedScanner.stop().catch(e=>console.log(e)); dedicatedScanner = null; }
                document.getElementById('app-interface').classList.add('hidden');
                document.getElementById('scanner-interface').classList.add('hidden'); 
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('mobile-menu').classList.add('hidden'); 
                document.getElementById('login-form-container').classList.add('hidden');
                document.getElementById('role-selector').classList.remove('hidden');
                document.getElementById('auth-input').value = '';
                document.getElementById('auth-pass').value = '';
                currentUser = null;
            }
            loader.classList.add('hidden');
        });

        // DEMO LOGIN FOR ADMIN
        window.demoAdminLogin = () => {
            const mockUser = { uid: "demo123", email: "master@asadevs.com", name: "Demo Admin", dept: "Staff", year: "N/A", role: "admin", bio: "Demo Mode" };
            currentUser = mockUser;
            loginSuccess(mockUser);
        };

        window.handleLoginSubmit = async (e) => {
            e.preventDefault();
            const inputVal = document.getElementById('auth-input').value.trim();
            const pass = document.getElementById('auth-pass').value;
            const loginType = document.getElementById('login-type').value;

            if(!inputVal || !pass) return Toastify({text: "Enter details", style: {background: "#ef4444"}}).showToast();
            let email = inputVal;

            if (loginType === 'student') {
                if (!/^\d+$/.test(inputVal)) return Toastify({text: "Please enter a valid numeric Student ID", style: {background: "#ef4444"}}).showToast();
                if (!isIdAllowed(inputVal)) return Toastify({text: "Invalid Student ID. Access Denied.", style: {background: "#ef4444"}}).showToast();
                email = `${inputVal}@asadevs.com`;
            } else if (loginType === 'admin') {
                if (!ADMIN_EMAILS.includes(inputVal) && !SCANNER_EMAILS.includes(inputVal)) {
                    if(!inputVal.includes('@')) return Toastify({text: "Please enter full email address", style: {background: "#ef4444"}}).showToast();
                }
                email = inputVal;
            }

            try {
                if(isRegistering && loginType === 'student') {
                    await createUserWithEmailAndPassword(auth, email, pass);
                    Toastify({text: "Account Created!", style: {background: "#10b981"}}).showToast();
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                    Toastify({text: "Logged In", style: {background: "#10b981"}}).showToast();
                }
            } catch (error) { Toastify({text: "Login Failed: Check ID/Email & Password", style: {background: "#ef4444"}}).showToast(); console.error(error); }
        };

        window.handleLogout = async () => {
            try {
                document.body.classList.remove('scanner-mode');
                document.getElementById('scanner-interface').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                await signOut(auth);
                setTimeout(() => window.location.reload(), 500);
            } catch (error) { console.error('Logout error:', error); }
        };
        
        window.saveProfileData = async () => {
            const user = auth.currentUser;
            if(!user) return;
            const name = document.getElementById('ob-name').value;
            const dept = document.getElementById('ob-dept').value;
            const year = document.getElementById('ob-year').value;
            if(!name) return alert("Name required");
            await setDoc(doc(db, "users", user.uid), { name, dept, year, bio: "Ready to learn.", email: user.email });
            location.reload(); 
        };

        function loginSuccess(user) {
            document.getElementById('auth-view').classList.add('hidden');
            if (user.role === 'scanner') {
                document.body.classList.add('scanner-mode');
                document.getElementById('app-interface').classList.add('hidden'); 
                document.getElementById('scanner-interface').classList.remove('hidden'); 
                document.getElementById('mobile-menu').style.display = 'none';
                document.addEventListener('keydown', preventScannerNavigation);
                setTimeout(initDedicatedScanner, 500);
            } else {
                document.body.classList.remove('scanner-mode');
                document.getElementById('scanner-interface').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                document.body.classList.toggle('is-admin', user.role === 'admin');
                document.getElementById('sb-name').innerText = user.name;
                document.getElementById('sb-avatar').innerText = user.name[0];
                document.getElementById('home-name').innerText = user.name;
                document.getElementById('prof-name').innerText = user.name;
                document.getElementById('prof-meta').innerText = user.role === 'admin' ? 'Administrator' : `${user.dept} • ${user.year}`;
                document.getElementById('prof-bio').innerText = user.bio || '';
                navTo('home');
                loadData();
            }
        }
        
        function preventScannerNavigation(e) {
            if(!document.body.classList.contains('scanner-mode')) return;
            if (e.altKey || (e.ctrlKey && (e.key === 'n' || e.key === 'w')) || (e.metaKey && e.key === 'w')) {
                e.preventDefault();
            }
        }

        async function loadData() {
            if(currentUser.role === 'scanner') return; 
            renderCollection('resources');
            renderCollection('courses');
            renderCollection('placement');
            renderCollection('events');
            if(currentUser.role === 'student') loadActivity();
            if(currentUser.role === 'admin') refreshLiveStats(); // Auto load monitor data
        }

        // --- NAVIGATION & ROUTING ---
        window.navTo = (id) => {
            if(document.body.classList.contains('scanner-mode')) return; 
            
            // HEARTBEAT UPDATE TRIGGER
            updateHeartbeat();

            document.getElementById('mobile-menu').classList.add('hidden');
            document.querySelectorAll('.section-view').forEach(e => e.classList.remove('active'));
            const target = document.getElementById(id);
            if(target) target.classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('bg-white/5', 'text-white'));
            const navBtn = document.getElementById(`nav-${id}`);
            if(navBtn) navBtn.classList.add('bg-white/5', 'text-white');

            const titles = { 'home': 'Dashboard', 'resources': 'Library', 'courses': 'Course Training', 'placement': 'Placement', 'events': 'Events/Seminars', 'profile': 'My Profile', 'activity': 'My Activity', 'monitor': 'Live Monitor' };
            document.getElementById('header-title').innerText = titles[id] || 'Dashboard';
            document.getElementById('header-subtitle').classList.toggle('hidden', id !== 'home');

            const actionBox = document.getElementById('header-action');
            actionBox.innerHTML = ''; // FIX FOR DUPLICATE BUTTONS

            if (currentUser && currentUser.role === 'admin') {
                const btnClass = "bg-blue-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition-all flex items-center gap-2 transform active:scale-95";
                let btnHtml = '';
                if(id === 'home' || id === 'events') {
                    btnHtml += `<button onclick="startScanner()" class="mr-2 bg-slate-900 text-white px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-slate-800 shadow-lg flex items-center gap-2"><i data-lucide="scan" class="w-4 h-4"></i> Scan QR</button>`;
                }
                
                if(id === 'monitor') {
                    // SHOW EXPORT BUTTON ON MONITOR PAGE
                     btnHtml = `<button onclick="exportLiveStatusCSV()" class="bg-green-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-green-700 shadow-lg flex items-center gap-2"><i data-lucide="download" class="w-4 h-4"></i> Export CSV</button>`;
                }

                if(id === 'resources') btnHtml = `<button onclick="openModal('resources')" class="${btnClass}"><i data-lucide="plus" class="w-4 h-4"></i> Add Resource</button>`;
                if(id === 'courses') btnHtml = `<button onclick="openModal('courses')" class="${btnClass}"><i data-lucide="plus" class="w-4 h-4"></i> Add Course Training</button>`;
                if(id === 'placement') btnHtml = `<button onclick="openModal('placement')" class="${btnClass}"><i data-lucide="briefcase" class="w-4 h-4"></i> Post Job</button>`;
                if(id === 'events') btnHtml += `<button onclick="openModal('events')" class="${btnClass}"><i data-lucide="calendar-plus" class="w-4 h-4"></i> Create Event</button>`;
                
                actionBox.innerHTML = btnHtml;
                lucide.createIcons();
            }
        };

        // --- NEW: Live Monitor with Card Design ---
        window.refreshLiveStats = async () => {
            const gridContainer = document.getElementById('grid-monitor');
            if(!gridContainer) return;
            
            gridContainer.innerHTML = '<div class="col-span-full flex justify-center p-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>';
            
            try {
                const usersSnap = await getDocs(collection(db, "users"));
                let onlineCount = 0;
                let totalStudents = 0;
                let cardsHtml = '';
                
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                let students = [];
                usersSnap.forEach(doc => {
                    const data = doc.data();
                    if(data.role === 'admin' || data.role === 'scanner') return; 
                    students.push({ ...data, lastSeenTime: data.lastSeen ? new Date(data.lastSeen) : new Date(0) });
                });

                students.sort((a, b) => b.lastSeenTime - a.lastSeenTime);

                students.forEach(student => {
                    totalStudents++;
                    const isOnline = student.lastSeenTime > fiveMinutesAgo;
                    if(isOnline) onlineCount++;

                    const timeStr = student.lastSeenTime.getTime() === new Date(0).getTime() 
                        ? 'Never' 
                        : student.lastSeenTime.toLocaleString();

                    // CARD DESIGN - MATCHING OTHER SECTIONS
                    const statusBadge = isOnline 
                        ? `<span class="bg-green-100 text-green-700 border border-green-200 px-2 py-1 rounded-full text-[10px] font-bold uppercase flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Online</span>`
                        : `<span class="bg-slate-100 text-slate-500 border border-slate-200 px-2 py-1 rounded-full text-[10px] font-bold uppercase">Offline</span>`;

                    cardsHtml += `
                        <div class="grid-item card-3d bg-white/90 backdrop-blur-sm p-5 rounded-xl border border-white/50 shadow-3d relative hover:border-blue-400">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center font-bold text-lg shadow-sm border border-blue-100">${student.name ? student.name[0] : '?'}</div>
                                    <div>
                                        <h3 class="font-bold text-slate-900 leading-tight">${student.name || 'Unknown'}</h3>
                                        <p class="text-xs text-slate-500 font-medium">${student.dept || 'N/A'} • ${student.year || 'N/A'}</p>
                                    </div>
                                </div>
                                ${statusBadge}
                            </div>
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-1">Last Activity</p>
                                <p class="text-xs font-mono text-slate-700 flex items-center gap-2">
                                    <i data-lucide="clock" class="w-3 h-3 text-slate-400"></i> ${timeStr}
                                </p>
                            </div>
                        </div>
                    `;
                });

                if(cardsHtml === '') cardsHtml = '<div class="col-span-full p-8 text-center text-slate-400 font-medium">No registered students found.</div>';

                document.getElementById('mon-online').innerText = onlineCount;
                document.getElementById('mon-total').innerText = totalStudents;
                gridContainer.innerHTML = cardsHtml;
                lucide.createIcons();

            } catch (e) {
                console.error(e);
                gridContainer.innerHTML = '<div class="col-span-full p-4 text-center text-red-500">Error loading data.</div>';
            }
        };

        // --- NEW: Export the Live Status Board ---
        window.exportLiveStatusCSV = async () => {
            Toastify({text: "Generating Report...", style: {background: "#3b82f6"}}).showToast();
            try {
                const usersSnap = await getDocs(collection(db, "users"));
                let csv = "Student Name,Department,Year,Status,Last Login Time\n";
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);

                usersSnap.forEach(doc => {
                    const data = doc.data();
                    if(data.role === 'admin' || data.role === 'scanner') return;

                    const lastSeenTime = data.lastSeen ? new Date(data.lastSeen) : new Date(0);
                    const isOnline = lastSeenTime > fiveMinutesAgo;
                    const status = isOnline ? "Online" : "Offline";
                    const timeStr = lastSeenTime.getTime() === 0 ? "Never" : lastSeenTime.toLocaleString();

                    csv += `"${data.name || 'Unknown'}","${data.dept || 'N/A'}","${data.year || 'N/A'}","${status}","${timeStr}"\n`;
                });

                downloadCSV(csv, `Student_Activity_Status_${new Date().toISOString().slice(0,10)}.csv`);
                Toastify({text: "Report Downloaded!", style: {background: "#10b981"}}).showToast();
            } catch (e) {
                console.error(e);
                Toastify({text: "Export failed", style: {background: "#ef4444"}}).showToast();
            }
        };
        
        // --- UTILITIES & MODAL HANDLERS ---
        window.togglePassword = (id, btn) => { const i = document.getElementById(id); if(i.type==='password'){i.type='text';btn.innerHTML='<i data-lucide="eye-off" class="w-5 h-5"></i>'}else{i.type='password';btn.innerHTML='<i data-lucide="eye" class="w-5 h-5"></i>'} lucide.createIcons(); };
        window.handleFileUpload = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const res = e.target.result;
                    if(modalType === 'resources') document.getElementById('i3').value = res;
                    else if(modalType === 'courses') document.getElementById('i5').value = res;
                    else if(modalType === 'placement') document.getElementById('i4').value = res;
                    else if(modalType === 'events') document.getElementById('i4').value = res;
                };
                reader.readAsDataURL(input.files[0]);
            }
        };
        window.openResume = () => document.getElementById('resume-view').classList.remove('hidden');
        window.downloadPDF = () => { const el = document.getElementById('resume-paper'); html2canvas(el, {scale:2}).then(c => { const pdf = new jspdf.jsPDF('p', 'mm', 'a4'); pdf.addImage(c.toDataURL('image/jpeg'), 'JPEG', 0, 0, 210, 297); pdf.save('Resume.pdf'); }); };
        window.toggleMobileMenu = () => { if(document.body.classList.contains('scanner-mode')) return; document.getElementById('mobile-menu').classList.toggle('hidden'); };
        window.loadPhoto = (i) => { if(i.files[0]) { const r=new FileReader(); r.onload=e=>{document.getElementById('res-img').src=e.target.result;document.getElementById('res-img').classList.remove('hidden');}; r.readAsDataURL(i.files[0]); } };
        lucide.createIcons();

        // --- NEW MODAL FUNCTIONS (COURSE/EVENT/PLACEMENT) ---
        window.openPlacementModal = (id, role, company, pay) => { /* Code as provided in original */ }; 
        window.closePlacementModal = () => document.getElementById('placement-apply-modal').classList.add('hidden');
        window.openProfileModal = () => document.getElementById('profile-edit-modal').classList.remove('hidden');
        window.closeProfileModal = () => document.getElementById('profile-edit-modal').classList.add('hidden');
        window.openCourseModal = (id, title, desc, link, cost) => {
            currentCourseId = id;
            currentCourseLink = link;
            document.getElementById('cd-title').innerText = title;
            document.getElementById('cd-desc').innerText = desc;
            document.getElementById('cd-cost').innerText = cost === 'Paid' ? 'Paid' : 'Free';
            document.getElementById('cd-prerequisites').innerHTML = `<li>Active internet connection</li><li>Basic programming knowledge</li>`;
            document.getElementById('cd-objectives').innerHTML = `<li>Master core concepts</li><li>Build projects</li><li>Earn certificate</li>`;
            document.getElementById('course-enroll-modal').classList.remove('hidden');
            lucide.createIcons();
        };
        window.closeCourseModal = () => document.getElementById('course-enroll-modal').classList.add('hidden');
        window.enrollFromModal = () => { if (currentCourseId) window.startCourse(currentCourseId, currentCourseLink); closeCourseModal(); };
        window.openEventModal = (id, name, date, location, desc, image, count, limit) => { /* Code as provided */ };
        window.closeEventModal = () => document.getElementById('event-register-modal').classList.add('hidden');
        window.openSupportModal = () => document.getElementById('support-modal').classList.remove('hidden');
        window.closeSupportModal = () => document.getElementById('support-modal').classList.add('hidden');
        
        // Export Helpers
        window.exportAllData = async (dataType) => {
            if (currentUser.role !== 'admin') return;
            try {
                let csvContent = '';
                let fileName = '';
                if (dataType === 'students') {
                    const snap = await getDocs(collection(db, "users"));
                    csvContent = "Student ID,Name,Department,Year,Email\n";
                    snap.forEach(doc => { const data = doc.data(); csvContent += `"${data.id || ''}","${data.name}","${data.dept}","${data.year}","${data.email}"\n`; });
                    fileName = 'students_export.csv';
                }
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                Toastify({text: "Data exported successfully!", style: {background: "#10b981"}}).showToast();
            } catch (error) { Toastify({text: "Error exporting data", style: {background: "#ef4444"}}).showToast(); }
        };
    </script>
</body>
</html>