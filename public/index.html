<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ASA Devs | Portal</title>
    <meta name="description" content="Official Training and Placement Portal.">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ASA Devs Portal">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'], heading: ['Outfit', 'sans-serif'] },
                    animation: { 'fade-up': 'fadeUp 0.4s ease-out forwards' },
                    keyframes: { fadeUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .section-view { display: none; }
        .section-view.active { display: block; animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .admin-control, .admin-view-only { display: none !important; }
        body.is-admin .admin-control { display: inline-flex !important; }
        body.is-admin .admin-view-only { display: grid !important; }
        body.is-admin .student-view-only { display: none !important; }
        [contenteditable="true"]:focus { outline: 2px solid #2563eb; background: rgba(37, 99, 235, 0.05); }
        .a4-page { width: 210mm; min-height: 297mm; background: white; margin: 0 auto; display: flex; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        #global-loader { display: flex; }
        #global-loader.hidden { display: none; }
        
        /* Scanner Overlay Animation */
        .scan-line { width: 100%; height: 3px; background: #ef4444; position: absolute; animation: scan 2.5s infinite linear; top: 0; box-shadow: 0 0 4px red; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        
        /* UI Polish */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .card-3d { perspective: 1000px; transition: transform 0.3s cubic-bezier(0.23, 1, 0.320, 1); }
        .card-3d:hover { transform: translateY(-5px) scale(1.01); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        /* SCANNER MODE - Complete UI Lockdown */
        body.scanner-mode { overflow: hidden !important; }
        body.scanner-mode #app-interface { display: none !important; visibility: hidden !important; }
        body.scanner-mode #mobile-menu { display: none !important; visibility: hidden !important; }
        body.scanner-mode #auth-view { display: none !important; visibility: hidden !important; }
        body.scanner-mode #scanner-interface { display: flex !important; visibility: visible !important; }
        body.scanner-mode * { pointer-events: none; }
        body.scanner-mode #scanner-interface, body.scanner-mode #scanner-interface * { pointer-events: auto; }
        
        /* SCANNER UI ENHANCEMENTS */
        #scanner-interface .scanner-header {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid rgba(59, 130, 246, 0.3);
        }
        
        #scanner-interface .scanner-status-text {
            font-family: 'Courier New', monospace;
            letter-spacing: 0.15em;
            background: linear-gradient(90deg, #60a5fa, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        #scanner-interface .scan-frame {
            background: radial-gradient(circle at center, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0) 70%);
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.3), inset 0 0 30px rgba(59, 130, 246, 0.1); }
            50% { box-shadow: 0 0 60px rgba(59, 130, 246, 0.5), inset 0 0 40px rgba(59, 130, 246, 0.2); }
        }
        
        #scanner-interface .corner-bracket {
            opacity: 0.8;
            transition: all 0.3s ease;
        }
        
        #scanner-interface:hover .corner-bracket {
            opacity: 1;
        }
        
        /* Notice Board Aesthetic */
        .notice-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-left: 4px solid #2563eb;
            transition: transform 0.2s cubic-bezier(0.2, 0, 0.2, 1);
            will-change: transform;
        }
        
        .notice-card:active {
            transform: scale(0.98);
        }
        
        .notice-tag {
            font-size: 0.65rem;
            letter-spacing: 0.05em;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 800;
        }
        
        .badge-pulse {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .badge-pulse::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            right: -8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        /* User-Friendly UI Polish */
        .action-blur {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        
        /* Make buttons feel like real buttons when pressed */
        .btn-tap {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-tap:active {
            transform: scale(0.95);
            filter: brightness(0.9);
        }
        
        /* Friendly labels */
        .info-label {
            font-size: 0.65rem;
            font-weight: 800;
            text-transform: uppercase;
            color: #94a3b8;
            letter-spacing: 0.025em;
            margin-bottom: 2px;
        }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col antialiased relative bg-slate-50">

    <div id="global-loader" class="fixed inset-0 z-[9999] bg-white flex items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>

    <div id="image-viewer" class="hidden fixed inset-0 z-[400] bg-black/95 flex items-center justify-center p-4 backdrop-blur-md transition-all" onclick="closeImageView()">
        <button onclick="closeImageView()" class="absolute top-6 right-6 text-white hover:text-gray-300 transition z-50"><i data-lucide="x" class="w-10 h-10"></i></button>
        <img id="full-image" src="" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl object-contain" onclick="event.stopPropagation()">
    </div>

    <div id="mobile-menu" class="hidden fixed inset-0 z-[300]">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleMobileMenu()"></div>
        <div class="absolute inset-y-0 left-0 w-3/4 max-w-xs bg-slate-900 shadow-2xl flex flex-col transition-transform">
            <div class="h-20 flex items-center justify-between px-6 border-b border-white/10">
                <button onclick="navTo('home')" class="flex items-center gap-3 text-white font-bold text-xl"><img src="logo.png" class="w-8 h-8 object-contain"> ASA Devs.</button>
                <button onclick="toggleMobileMenu()" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
                <button onclick="navTo('home')" class="nav-item active w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard</button>
                <button onclick="navTo('resources')" class="nav-item w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="folder" class="w-5 h-5 mr-3"></i> Library</button>
                <button onclick="navTo('courses')" class="nav-item w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="book-open" class="w-5 h-5 mr-3"></i> Training</button>
                <button onclick="navTo('placement')" class="nav-item w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="briefcase" class="w-5 h-5 mr-3"></i> Placement</button>
                <button onclick="navTo('events')" class="nav-item w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="calendar" class="w-5 h-5 mr-3"></i> Events</button>
                <button onclick="navTo('activity')" class="nav-item w-full student-view-only flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="activity" class="w-5 h-5 mr-3"></i> Activity</button>
                <button onclick="navTo('profile')" class="nav-item w-full student-view-only flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition mt-4 border-t border-white/10"><i data-lucide="user" class="w-5 h-5 mr-3"></i> Profile</button>
            </nav>
            <div class="p-6 border-t border-white/10 bg-slate-950">
                <button onclick="handleLogout()" class="flex items-center text-red-400 font-bold"><i data-lucide="log-out" class="w-5 h-5 mr-2"></i> Sign Out</button>
            </div>
        </div>
    </div>

    <div id="auth-view" class="fixed inset-0 z-[100] flex bg-transparent">
        <div class="hidden lg:flex lg:w-1/2 bg-slate-900/90 backdrop-blur-xl items-center justify-center flex-col relative overflow-hidden text-white">
            <div class="absolute inset-0 bg-gradient-to-br from-blue-600/20 to-purple-600/20"></div>
            <img src="logo.png" class="w-32 h-32 object-contain mb-6 animate-fade-up relative z-10">
            <div class="text-center z-10 p-10">
                <h1 class="text-6xl font-bold mb-4 tracking-tight">TSDC.</h1>
                <p class="text-slate-400 text-xl font-light">Training & Placement Portal</p>
            </div>
        </div>
        <div class="w-full lg:w-1/2 flex items-center justify-center p-6 bg-white/60 backdrop-blur-md">
            <div class="w-full max-w-md bg-white/90 p-8 rounded-3xl shadow-2xl border border-white/50">
                
                <div id="role-selector" class="animate-fade-up">
                    <div class="lg:hidden flex justify-center mb-8"><img src="logo.png" class="w-20 h-20 object-contain"></div>
                    <h2 class="text-3xl font-bold text-slate-900 mb-2 text-center">Welcome</h2>
                    <p class="text-slate-500 mb-8 text-center">Select access level</p>
                    <div class="space-y-4">
                        <button onclick="setAuthMode('student')" class="w-full p-5 border-2 border-slate-100 rounded-2xl hover:border-blue-500 hover:bg-blue-50 transition flex items-center gap-4 group bg-white">
                            <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center"><i data-lucide="graduation-cap"></i></div>
                            <div class="text-left"><h3 class="font-bold text-lg">Student</h3><p class="text-sm text-slate-500">Log in using Roll No</p></div>
                        </button>
                        <button onclick="setAuthMode('admin')" class="w-full p-5 border-2 border-slate-100 rounded-2xl hover:border-slate-800 hover:bg-slate-50 transition flex items-center gap-4 group bg-white">
                            <div class="w-12 h-12 bg-slate-100 text-slate-700 rounded-xl flex items-center justify-center"><i data-lucide="shield"></i></div>
                            <div class="text-left"><h3 class="font-bold text-lg">Faculty / Scanner</h3><p class="text-sm text-slate-500">Log in using Email</p></div>
                        </button>
                    </div>
                </div>

                <div id="login-form-container" class="hidden animate-fade-up">
                    <button onclick="resetAuth()" class="mb-6 text-sm font-bold text-slate-400 hover:text-slate-800 flex items-center gap-1"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back</button>
                    <h2 class="text-3xl font-bold text-slate-900 mb-2" id="login-title">Login</h2>
                    <p class="text-slate-500 mb-6" id="login-subtitle">Enter credentials</p>
                    <form onsubmit="handleLoginSubmit(event)" class="space-y-4">
                        <input type="hidden" id="login-type">
                        <div>
                            <label class="text-xs font-bold uppercase text-slate-500 block mb-1" id="email-label">ID / Email</label>
                            <input type="text" id="auth-input" class="w-full p-3 bg-white border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition">
                        </div>
                        <div>
                            <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Password</label>
                            <div class="relative">
                                <input type="password" id="auth-pass" class="w-full p-3 pr-12 bg-white border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition">
                                <button type="button" onclick="togglePassword('auth-pass', this)" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 p-1"><i data-lucide="eye" class="w-5 h-5"></i></button>
                            </div>
                        </div>
                        <div id="register-hint" class="text-right hidden"><a href="#" onclick="toggleRegisterMode()" class="text-xs text-blue-600 font-bold hover:underline">New Student? Register</a></div>
                        <div id="login-hint" class="text-right hidden"><a href="#" onclick="toggleRegisterMode()" class="text-xs text-blue-600 font-bold hover:underline">Have account? Login</a></div>
                        <button type="submit" id="auth-btn-text" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl hover:bg-slate-800 transition shadow-lg mt-2">Access Portal</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="onboarding-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl max-w-md w-full shadow-2xl animate-fade-up">
            <h2 class="text-2xl font-bold mb-2">Profile Setup</h2>
            <p class="text-slate-500 mb-6">Complete your profile to continue.</p>
            <div class="space-y-4">
                <input id="ob-name" placeholder="Full Name" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 transition">
                <select id="ob-dept" class="w-full p-3 border rounded-xl bg-white outline-none focus:border-blue-500 transition">
                    <option value="" disabled selected>Select Department</option>
                    <option>BSC IT</option><option>BSC CS</option><option>BSC DS</option><option>BAMMC</option><option>BCOM</option><option>BAF</option><option>BMS</option><option>MSC</option><option>BSC</option>
                </select>
                <select id="ob-year" class="w-full p-3 border rounded-xl bg-white outline-none focus:border-blue-500 transition">
                    <option value="" disabled selected>Select Year</option>
                    <option>FY</option><option>SY</option><option>TY</option><option>MSC 1</option><option>MSC 2</option>
                </select>
                <button onclick="saveProfileData()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 shadow-lg">Initialize</button>
            </div>
        </div>
    </div>

    <div id="scanner-interface" class="hidden fixed inset-0 z-[5000] bg-black flex flex-col w-screen h-screen">
        <!-- Enhanced Header -->
        <div class="scanner-header h-20 flex items-center justify-between px-6 shrink-0 fixed top-0 w-full z-10 bg-black border-b border-white/10">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <div class="w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse shadow-[0_0_15px_rgb(239,68,68)]"></div>
                    <span class="scanner-status-text text-white font-bold text-sm">GATEKEEPER</span>
                </div>
                <div class="hidden sm:block h-6 w-px bg-white/10"></div>
                <span class="hidden sm:block text-xs text-slate-400 font-medium">Event Check-In System</span>
            </div>
            <div class="flex items-center gap-3">
                <span id="scan-counter" class="text-xs font-mono text-blue-400 px-3 py-1.5 bg-blue-500/10 rounded-lg border border-blue-500/20">Scans: 0</span>
                <button onclick="handleLogout()" class="text-xs font-bold text-red-400 border border-red-400/40 px-4 py-2 rounded-lg hover:bg-red-400/10 hover:border-red-400/60 transition active:scale-95 cursor-pointer" style="transition: opacity 0.2s ease;">LOGOUT</button>
            </div>
        </div>
        
        <!-- Camera Feed Area -->
        <div class="fixed top-20 left-0 right-0 bottom-0 flex flex-col relative overflow-hidden bg-black">
            <div id="dedicated-reader" class="w-full h-full object-cover"></div>
            
            <!-- Scanning Overlay with Enhanced Design -->
            <div class="absolute inset-0 pointer-events-none flex items-center justify-center">
                <!-- Gradient Vignette -->
                <div class="absolute inset-0 bg-gradient-to-b from-transparent via-transparent to-black/40"></div>
                
                <!-- Scanning Frame -->
                <div class="scan-frame w-72 h-72 border-2 border-blue-400/60 rounded-3xl relative">
                    <div class="scan-line"></div>
                    <!-- Corner Brackets -->
                    <div class="corner-bracket absolute top-0 left-0 w-10 h-10 border-t-4 border-l-4 border-cyan-400 rounded-tl-2xl"></div>
                    <div class="corner-bracket absolute top-0 right-0 w-10 h-10 border-t-4 border-r-4 border-cyan-400 rounded-tr-2xl"></div>
                    <div class="corner-bracket absolute bottom-0 left-0 w-10 h-10 border-b-4 border-l-4 border-cyan-400 rounded-bl-2xl"></div>
                    <div class="corner-bracket absolute bottom-0 right-0 w-10 h-10 border-b-4 border-r-4 border-cyan-400 rounded-br-2xl"></div>
                </div>
                
                <!-- Instruction Text -->
                <div class="absolute bottom-32 text-center pointer-events-none">
                    <p class="text-sm text-cyan-300/80 font-medium tracking-wide">ALIGN QR CODE IN FRAME</p>
                </div>
            </div>
            
            <!-- Status Panel -->
            <div id="scan-status-panel" class="absolute bottom-0 inset-x-0 bg-gradient-to-t from-slate-900 via-slate-900/95 to-transparent rounded-t-3xl p-8 transform transition-transform duration-300 translate-y-full z-20 shadow-2xl border-t border-blue-500/20 backdrop-blur-xl">
                <div class="flex flex-col items-center text-center max-w-md mx-auto">
                    <div id="status-icon" class="w-20 h-20 rounded-full flex items-center justify-center mb-6 text-white shadow-xl text-4xl border-2"></div>
                    <h2 id="status-title" class="text-2xl font-bold text-white mb-2">Checking...</h2>
                    <p id="status-desc" class="text-slate-300 mb-8 text-sm leading-relaxed">Verifying ticket details...</p>
                    
                    <!-- Student Details Card -->
                    <div id="student-details" class="bg-slate-800/50 w-full p-6 rounded-2xl mb-8 text-left border border-slate-700 hidden backdrop-blur-sm">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Student Information</p>
                                <p id="sd-name" class="font-bold text-white text-lg">Name</p>
                            </div>
                            <span class="bg-emerald-500/20 text-emerald-300 text-[10px] font-bold px-3 py-1 rounded-full border border-emerald-500/30">âœ“ VALID</span>
                        </div>
                        <p id="sd-id" class="text-xs font-mono text-slate-400 mt-2">ID: 000</p>
                    </div>
                    
                    <!-- Action Button -->
                    <button onclick="resetScannerUI()" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white font-bold py-4 rounded-xl hover:from-blue-500 hover:to-cyan-500 transition active:scale-95 shadow-lg">
                        Scan Next Ticket
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-interface" class="hidden flex h-screen bg-transparent">
        <aside class="hidden md:flex w-64 flex-col bg-slate-900/95 backdrop-blur-xl text-slate-400 h-full fixed z-20 shadow-2xl transition-all duration-300">
            <button onclick="navTo('home')" class="h-20 flex items-center px-6 gap-3 border-b border-white/10 shrink-0 hover:bg-white/5 transition w-full text-left cursor-pointer">
                <img src="logo.png" class="w-8 h-8 object-contain">
                <span class="text-white font-bold text-xl tracking-tight">ASA Devs.</span>
            </button>
            <nav class="flex-1 px-3 py-6 space-y-1 overflow-y-auto">
                <button id="nav-home" onclick="navTo('home')" class="nav-item active w-full flex items-center px-3 py-3 rounded-lg hover:bg-white/5 hover:text-white transition"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard</button>
                <button id="nav-resources" onclick="navTo('resources')" class="nav-item w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="folder" class="w-5 h-5 mr-3"></i> Library</button>
                <button id="nav-courses" onclick="navTo('courses')" class="nav-item w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="book-open" class="w-5 h-5 mr-3"></i> Training</button>
                <button id="nav-placement" onclick="navTo('placement')" class="nav-item w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="briefcase" class="w-5 h-5 mr-3"></i> Placement</button>
                <button id="nav-events" onclick="navTo('events')" class="nav-item w-full flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="calendar" class="w-5 h-5 mr-3"></i> Events</button>
                <button id="nav-activity" onclick="navTo('activity')" class="nav-item w-full student-view-only flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="activity" class="w-5 h-5 mr-3"></i> Activity</button>
                <button onclick="openSupportModal()" class="nav-item w-full student-view-only flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition"><i data-lucide="message-circle" class="w-5 h-5 mr-3"></i> Support</button>
                <button id="nav-profile" onclick="navTo('profile')" class="nav-item w-full student-view-only flex items-center px-4 py-4 rounded-xl text-slate-400 hover:bg-white/10 hover:text-white transition mt-4 border-t border-white/10"><i data-lucide="user" class="w-5 h-5 mr-3"></i> Profile</button>
            </nav>
            <div class="p-4 border-t border-white/10 shrink-0">
                <div class="flex items-center gap-3 mb-3"><div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xs" id="sb-avatar">U</div><div class="text-sm font-bold text-white truncate" id="sb-name">User</div></div>
                <button onclick="openStatsModal()" class="admin-control text-xs font-bold text-blue-400 hover:text-blue-300 w-full text-left mb-2 block">ðŸ“Š STATISTICS</button>
                <button onclick="handleLogout()" class="text-xs font-bold text-red-400 hover:text-red-300 w-full text-left">LOGOUT</button>
            </div>
        </aside>

        <main class="flex-1 md:ml-64 flex flex-col h-full overflow-hidden relative bg-slate-50">
            <header class="h-20 bg-white/80 backdrop-blur-md border-b flex items-center justify-between px-6 md:px-10 sticky top-0 z-30 shrink-0">
                <div class="flex items-center gap-3 md:hidden">
                    <button onclick="navTo('home')" class="flex items-center gap-2"><img src="logo.png" class="w-8 h-8"><span class="font-bold text-xl">ASA Devs.</span></button>
                </div>
                <div class="hidden md:block">
                    <h1 id="header-title" class="text-2xl font-bold text-slate-900">Dashboard</h1>
                    <p id="header-subtitle" class="text-sm text-slate-500 hidden">Manage system</p>
                </div>
                <div class="flex items-center gap-4">
                    <div id="header-action"></div>
                    <button onclick="toggleMobileMenu()" class="md:hidden p-2 bg-slate-100 rounded-lg"><i data-lucide="menu"></i></button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-6 md:p-10 scroll-smooth">
                <div id="home" class="section-view active max-w-6xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4">
                        <div><h1 class="text-3xl font-bold text-slate-900">Hello, <span id="home-name">User</span></h1><p class="text-slate-600" id="home-subtitle">Welcome to your cloud dashboard.</p></div>
                        <span class="admin-view-only bg-slate-900 text-white px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider">Faculty Mode</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <button onclick="navTo('resources')" class="stat-card text-left w-full bg-white p-6 rounded-2xl border shadow-sm hover:shadow-md cursor-pointer group"><div class="text-slate-500 text-xs uppercase font-bold group-hover:text-blue-600">Total Resources</div><div class="text-3xl font-bold mt-1 text-slate-900" id="stat-res">--</div></button>
                        <button onclick="navTo('courses')" class="stat-card text-left w-full bg-white p-6 rounded-2xl border shadow-sm hover:shadow-md cursor-pointer group"><div class="text-slate-500 text-xs uppercase font-bold group-hover:text-blue-600">Active Trainings</div><div class="text-3xl font-bold mt-1 text-slate-900" id="stat-course">--</div></button>
                        <button onclick="navTo('placement')" class="stat-card text-left w-full bg-white p-6 rounded-2xl border shadow-sm hover:shadow-md cursor-pointer group"><div class="text-slate-500 text-xs uppercase font-bold group-hover:text-blue-600">Job Postings</div><div class="text-3xl font-bold mt-1 text-slate-900" id="stat-job">--</div></button>
                    </div>
                </div>

                <div id="resources" class="section-view max-w-6xl mx-auto">
                    <div class="md:hidden flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Library</h2><button onclick="openModal('resources')" class="admin-control bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg">+ Add</button></div>
                    <input onkeyup="filterGrid('grid-resources', this.value)" placeholder="Search resources..." class="w-full p-3 border rounded-xl mb-4 bg-white/50 backdrop-blur outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="grid-resources" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                </div>

                <div id="courses" class="section-view max-w-6xl mx-auto">
                    <div class="md:hidden flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Training</h2><button onclick="openModal('courses')" class="admin-control bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg">+ Add</button></div>
                    <input onkeyup="filterGrid('grid-courses', this.value)" placeholder="Search courses..." class="w-full p-3 border rounded-xl mb-4 bg-white/50 backdrop-blur outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="grid-courses" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                </div>

                <div id="placement" class="section-view max-w-6xl mx-auto">
                    <div class="md:hidden flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Placement</h2><button onclick="openModal('placement')" class="admin-control bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg">+ Add</button></div>
                    <input onkeyup="filterGrid('grid-placement', this.value)" placeholder="Search jobs..." class="w-full p-3 border rounded-xl mb-4 bg-white/50 backdrop-blur outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="grid-placement" class="grid grid-cols-1 gap-3"></div>
                </div>

                <div id="events" class="section-view max-w-6xl mx-auto">
                    <div class="md:hidden flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Events</h2><button onclick="openModal('events')" class="admin-control bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg">+ Add</button></div>
                    <input onkeyup="filterGrid('grid-events', this.value)" placeholder="Search events..." class="w-full p-3 border rounded-xl mb-4 bg-white/50 backdrop-blur outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="grid-events" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                </div>

                <div id="activity" class="section-view max-w-6xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6">My Activity</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-2xl border shadow-sm"><h3 class="font-bold text-lg mb-4 flex items-center"><i data-lucide="ticket" class="w-5 h-5 mr-2 text-blue-600"></i> Event Registrations</h3><div id="my-events-list" class="space-y-3"></div></div>
                        <div class="bg-white p-6 rounded-2xl border shadow-sm"><h3 class="font-bold text-lg mb-4 flex items-center"><i data-lucide="award" class="w-5 h-5 mr-2 text-green-600"></i> Completed Courses</h3><div id="my-courses-list" class="space-y-3"></div></div>
                    </div>
                </div>

                <div id="profile" class="section-view max-w-4xl mx-auto">
                    <div class="bg-white p-8 rounded-2xl border shadow-sm mb-6 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                        <div><h1 class="text-3xl font-bold mb-1" id="prof-name">User</h1><p class="text-slate-500" id="prof-meta">Department â€¢ Year</p></div>
                        <button onclick="openResume()" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-slate-800 w-full md:w-auto">Resume Builder</button>
                    </div>
                    <div class="bg-white p-8 rounded-2xl border shadow-sm mb-6"><div class="flex justify-between mb-4"><h3 class="font-bold">Bio</h3><button onclick="openProfileModal()" class="text-blue-600 text-xs font-bold hover:underline">EDIT PROFILE</button></div><p id="prof-bio" class="text-slate-600 p-2">Loading...</p></div>
                </div>
            </div>
        </main>
    </div>

    <div id="data-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4"><div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl animate-fade-up"><div class="flex justify-between mb-4"><h3 class="font-bold text-xl" id="modal-title">Add Item</h3><button onclick="document.getElementById('data-modal').classList.add('hidden')"><i data-lucide="x"></i></button></div><div id="modal-fields" class="space-y-3"></div><input type="file" id="unified-file-input" class="hidden" onchange="handleFileUpload(this)"><button id="modal-save" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl mt-6 hover:bg-blue-700">Save to Cloud</button></div></div>

    <div id="ticket-modal" class="hidden fixed inset-0 z-[300] flex items-center justify-center bg-slate-900/60 backdrop-blur-md p-4 transition-all duration-300">
        <div class="w-full max-w-xs md:max-w-sm bg-white rounded-3xl shadow-2xl overflow-hidden relative animate-fade-up transform transition-all hover:scale-[1.02]">
            <div class="absolute top-0 right-0 w-32 h-32 bg-blue-100 rounded-full mix-blend-multiply filter blur-3xl opacity-50 pointer-events-none"></div>
            <div class="absolute bottom-0 left-0 w-32 h-32 bg-purple-100 rounded-full mix-blend-multiply filter blur-3xl opacity-50 pointer-events-none"></div>
            <button onclick="document.getElementById('ticket-modal').classList.add('hidden')" class="absolute top-4 right-4 z-20 text-white/70 hover:text-white bg-black/20 hover:bg-black/40 rounded-full p-1 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="bg-slate-900 p-8 text-white relative"><div class="relative z-10"><div class="inline-block px-2 py-1 rounded bg-blue-500/20 text-blue-300 text-[10px] font-bold tracking-widest uppercase mb-3 border border-blue-500/30">Admit One</div><h1 id="t-event-name" class="text-2xl font-bold leading-tight mb-1 text-white">Event</h1><p class="text-slate-400 text-xs font-medium">Official Event Pass</p></div></div>
            <div class="p-6 relative z-10"><div class="flex justify-between items-start mb-6 border-b border-slate-100 pb-4"><div><p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-1">Date</p><p id="t-date" class="font-bold text-slate-800 text-sm flex items-center"><i data-lucide="calendar" class="w-3 h-3 mr-1.5 text-blue-500"></i> <span id="t-date-text">--</span></p></div><div class="text-right"><p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-1">Location</p><p id="t-loc" class="font-bold text-slate-800 text-sm flex items-center justify-end"><span id="t-loc-text">--</span> <i data-lucide="map-pin" class="w-3 h-3 ml-1.5 text-red-500"></i></p></div></div><div class="flex flex-col items-center justify-center mb-6"><div class="p-1 bg-gradient-to-tr from-blue-500 to-purple-500 rounded-2xl shadow-lg"><div class="bg-white p-3 rounded-xl"><div id="qrcode"></div></div></div><p class="mt-3 text-[10px] text-slate-400 font-medium uppercase tracking-widest">Scan at Entrance</p></div><div class="bg-slate-50 rounded-xl p-4 border border-slate-100 text-center"><h3 id="t-student" class="text-sm font-bold text-slate-900">Student Name</h3><p id="t-id" class="text-xs font-mono text-slate-500 mt-1">ID: 000000</p></div></div>
        </div>
    </div>

    <div id="scanner-modal" class="hidden fixed inset-0 z-[400] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4"><div class="bg-white w-full max-w-md rounded-2xl overflow-hidden relative"><button onclick="stopScanner()" class="absolute top-4 right-4 z-50 text-white bg-black/50 rounded-full p-1"><i data-lucide="x"></i></button><div id="reader" class="w-full h-64 bg-black"></div><div class="p-4 text-center"><p class="font-bold">Scan QR</p><p class="text-xs text-slate-500">Align within frame</p></div></div></div>

    <input type="file" id="cert-upload-input" class="hidden" accept="image/*,.pdf">

    <!-- PLACEMENT APPLICATION FORM MODAL -->
    <div id="placement-apply-modal" class="hidden fixed inset-0 z-[300] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 transition-all">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl animate-fade-up overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl">Apply for Position</h3>
                <button onclick="closePlacementModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="placement-role-info" class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6"></div>
            <form onsubmit="submitPlacementApplication(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Full Name *</label>
                    <input type="text" id="pa-name" placeholder="Your full name" class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Email *</label>
                    <input type="email" id="pa-email" placeholder="your.email@college.com" class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Phone *</label>
                    <input type="tel" id="pa-phone" placeholder="+91 98765 43210" class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Resume Link (Google Drive/Dropbox) *</label>
                    <input type="url" id="pa-resume" placeholder="https://drive.google.com/file/d/..." class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Cover Letter / Why join us?</label>
                    <textarea id="pa-letter" placeholder="Tell us why you're interested in this role..." class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 h-28 resize-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Expected Salary (â‚¹/month)</label>
                    <input type="number" id="pa-salary" placeholder="Leave blank if negotiable" class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">LinkedIn Profile (Optional)</label>
                    <input type="url" id="pa-linkedin" placeholder="https://linkedin.com/in/yourprofile" class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closePlacementModal()" class="flex-1 py-3 border border-slate-300 rounded-xl font-bold text-slate-700 hover:bg-slate-50">Cancel</button>
                    <button type="submit" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700">Submit Application</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PROFILE EDIT MODAL -->
    <div id="profile-edit-modal" class="hidden fixed inset-0 z-[300] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 transition-all">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl animate-fade-up overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl">Edit Profile</h3>
                <button onclick="closeProfileModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form onsubmit="submitProfileUpdate(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Full Name</label>
                    <input type="text" id="prof-edit-name" placeholder="Full Name" class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Department</label>
                    <select id="prof-edit-dept" class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Department</option>
                        <option value="CSE">Computer Science (CSE)</option>
                        <option value="ECE">Electronics (ECE)</option>
                        <option value="ME">Mechanical (ME)</option>
                        <option value="CE">Civil (CE)</option>
                        <option value="EEE">Electrical (EEE)</option>
                        <option value="BT">Biotechnology (BT)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Year</label>
                    <select id="prof-edit-year" class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Year</option>
                        <option value="1st Year">1st Year</option>
                        <option value="2nd Year">2nd Year</option>
                        <option value="3rd Year">3rd Year</option>
                        <option value="4th Year">4th Year</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Phone Number</label>
                    <input type="tel" id="prof-edit-phone" placeholder="+91 98765 43210" class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Bio / About You</label>
                    <textarea id="prof-edit-bio" placeholder="Tell us about yourself..." class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 h-24 resize-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">LinkedIn Profile</label>
                    <input type="url" id="prof-edit-linkedin" placeholder="https://linkedin.com/in/yourprofile" class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeProfileModal()" class="flex-1 py-3 border border-slate-300 rounded-xl font-bold text-slate-700 hover:bg-slate-50">Cancel</button>
                    <button type="submit" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- COURSE ENROLLMENT DETAILS MODAL -->
    <div id="course-enroll-modal" class="hidden fixed inset-0 z-[300] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 transition-all">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl animate-fade-up overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl">Course Details</h3>
                <button onclick="closeCourseModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="course-details-content" class="space-y-4 mb-6">
                <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
                    <h4 id="cd-title" class="font-bold text-lg mb-2"></h4>
                    <p id="cd-desc" class="text-sm text-slate-600 mb-4"></p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-blue-50 rounded-xl p-4 border border-blue-200 text-center">
                    <p class="text-[10px] font-bold text-slate-600 uppercase tracking-widest mb-1">Duration</p>
                    <p id="cd-duration" class="font-bold text-slate-800">Self-paced</p>
                </div>
                <div class="bg-green-50 rounded-xl p-4 border border-green-200 text-center">
                    <p class="text-[10px] font-bold text-slate-600 uppercase tracking-widest mb-1">Cost</p>
                    <p id="cd-cost" class="font-bold text-slate-800">Free</p>
                </div>
            </div>
            <div class="bg-amber-50 border-l-4 border-amber-400 p-4 rounded mb-6">
                <h4 class="font-bold text-sm text-amber-900 mb-2">ðŸ“‹ Prerequisites:</h4>
                <ul id="cd-prerequisites" class="text-sm text-amber-800 space-y-1 list-disc list-inside"></ul>
            </div>
            <div class="bg-slate-50 p-4 rounded-xl mb-6">
                <h4 class="font-bold text-sm text-slate-700 mb-2">âœ“ Learning Objectives:</h4>
                <ul id="cd-objectives" class="text-sm text-slate-600 space-y-1 list-disc list-inside"></ul>
            </div>
            <div class="flex gap-3">
                <button onclick="closeCourseModal()" class="flex-1 py-3 border border-slate-300 rounded-xl font-bold text-slate-700 hover:bg-slate-50">Close</button>
                <button onclick="enrollFromModal()" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 flex items-center justify-center gap-2">
                    <i data-lucide="play" class="w-4 h-4"></i> Start Course
                </button>
            </div>
        </div>
    </div>

    <!-- EVENT REGISTRATION DETAILS MODAL -->
    <div id="event-register-modal" class="hidden fixed inset-0 z-[300] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 transition-all">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl animate-fade-up overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl">Event Details</h3>
                <button onclick="closeEventModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="bg-slate-100 rounded-xl h-32 mb-4 overflow-hidden" id="ed-image"></div>
            <h4 id="ed-name" class="font-bold text-xl mb-2 text-slate-900"></h4>
            <div class="space-y-3 mb-6">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-50 p-2.5 rounded-lg"><i data-lucide="calendar" class="w-4 h-4 text-blue-600"></i></div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Date & Time</p>
                        <p id="ed-date" class="font-bold text-slate-800"></p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="bg-red-50 p-2.5 rounded-lg"><i data-lucide="map-pin" class="w-4 h-4 text-red-600"></i></div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Location</p>
                        <p id="ed-location" class="font-bold text-slate-800"></p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="bg-green-50 p-2.5 rounded-lg"><i data-lucide="users" class="w-4 h-4 text-green-600"></i></div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Capacity</p>
                        <p id="ed-capacity" class="font-bold text-slate-800"></p>
                    </div>
                </div>
            </div>
            <div class="bg-slate-50 rounded-xl p-4 mb-6">
                <h4 class="font-bold text-sm text-slate-700 mb-2">About This Event:</h4>
                <p id="ed-description" class="text-sm text-slate-600 line-clamp-4"></p>
            </div>
            <form onsubmit="submitEventRegistration(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Dietary Preferences</label>
                    <select id="ed-dietary" class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="None">No restrictions</option>
                        <option value="Veg">Vegetarian</option>
                        <option value="Vegan">Vegan</option>
                        <option value="Gluten-free">Gluten-free</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Special Requirements (Optional)</label>
                    <input type="text" id="ed-special" placeholder="e.g., Wheelchair access, Allergy info, etc." class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeEventModal()" class="flex-1 py-3 border border-slate-300 rounded-xl font-bold text-slate-700 hover:bg-slate-50">Cancel</button>
                    <button type="submit" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 flex items-center justify-center gap-2">
                        <i data-lucide="check" class="w-4 h-4"></i> Register
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- SUPPORT/CONTACT FORM MODAL -->
    <div id="support-modal" class="hidden fixed inset-0 z-[300] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 transition-all">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl animate-fade-up overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl">Contact Support</h3>
                <button onclick="closeSupportModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form onsubmit="submitSupportQuery(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Issue Type *</label>
                    <select id="support-type" class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Select type of issue</option>
                        <option value="Technical">Technical Issue</option>
                        <option value="Course">Course Related</option>
                        <option value="Placement">Placement Related</option>
                        <option value="Event">Event Related</option>
                        <option value="Account">Account Issue</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Subject *</label>
                    <input type="text" id="support-subject" placeholder="Brief description of your issue" class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Message *</label>
                    <textarea id="support-message" placeholder="Please describe your issue in detail..." class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 h-32 resize-none" required></textarea>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Preferred Contact Method</label>
                    <select id="support-contact" class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="Email">Email</option>
                        <option value="WhatsApp">WhatsApp</option>
                        <option value="Phone">Phone</option>
                    </select>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeSupportModal()" class="flex-1 py-3 border border-slate-300 rounded-xl font-bold text-slate-700 hover:bg-slate-50">Cancel</button>
                    <button type="submit" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700">Send Message</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADMIN STATISTICS DASHBOARD MODAL -->
    <div id="admin-stats-modal" class="hidden fixed inset-0 z-[300] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 transition-all">
        <div class="bg-white w-full max-w-2xl rounded-2xl p-6 shadow-2xl animate-fade-up overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl">Portal Statistics</h3>
                <button onclick="closeStatsModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold text-blue-600 mb-1" id="stat-students">0</div>
                    <p class="text-xs font-bold text-slate-600 uppercase tracking-wider">Students</p>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold text-green-600 mb-1" id="stat-enrollments">0</div>
                    <p class="text-xs font-bold text-slate-600 uppercase tracking-wider">Enrollments</p>
                </div>
                <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold text-orange-600 mb-1" id="stat-registrations">0</div>
                    <p class="text-xs font-bold text-slate-600 uppercase tracking-wider">Event Regs</p>
                </div>
                <div class="bg-purple-50 border border-purple-200 rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold text-purple-600 mb-1" id="stat-applications">0</div>
                    <p class="text-xs font-bold text-slate-600 uppercase tracking-wider">Applications</p>
                </div>
                <div class="bg-red-50 border border-red-200 rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold text-red-600 mb-1" id="stat-support-tickets">0</div>
                    <p class="text-xs font-bold text-slate-600 uppercase tracking-wider">Support</p>
                </div>
                <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold text-indigo-600 mb-1" id="stat-feedback">0</div>
                    <p class="text-xs font-bold text-slate-600 uppercase tracking-wider">Feedback</p>
                </div>
            </div>
            <div class="border-t pt-4">
                <h4 class="font-bold text-slate-700 mb-4">Quick Actions</h4>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportAllData('students')" class="py-2 px-4 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-bold text-slate-700">Export Students</button>
                    <button onclick="exportAllData('applications')" class="py-2 px-4 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-bold text-slate-700">Export Applications</button>
                    <button onclick="exportAllData('support')" class="py-2 px-4 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-bold text-slate-700">Export Support Tickets</button>
                    <button onclick="closeStatsModal()" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- EVENT FEEDBACK FORM MODAL -->
    <div id="event-feedback-modal" class="hidden fixed inset-0 z-[300] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 transition-all">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl animate-fade-up overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl">Event Feedback</h3>
                <button onclick="closeEventFeedbackModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                <p class="text-sm font-bold text-blue-900">Thanks for attending! <br> Your feedback helps us improve.</p>
            </div>
            <form onsubmit="submitEventFeedback(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-3">Rate this event (1-5 stars) *</label>
                    <div class="flex gap-3" id="feedback-stars">
                        <button type="button" onclick="setRating(1)" class="star-btn w-10 h-10 rounded-full border-2 border-slate-300 text-lg font-bold hover:bg-amber-100 transition-all" data-value="1">â­</button>
                        <button type="button" onclick="setRating(2)" class="star-btn w-10 h-10 rounded-full border-2 border-slate-300 text-lg font-bold hover:bg-amber-100 transition-all" data-value="2">â­</button>
                        <button type="button" onclick="setRating(3)" class="star-btn w-10 h-10 rounded-full border-2 border-slate-300 text-lg font-bold hover:bg-amber-100 transition-all" data-value="3">â­</button>
                        <button type="button" onclick="setRating(4)" class="star-btn w-10 h-10 rounded-full border-2 border-slate-300 text-lg font-bold hover:bg-amber-100 transition-all" data-value="4">â­</button>
                        <button type="button" onclick="setRating(5)" class="star-btn w-10 h-10 rounded-full border-2 border-slate-300 text-lg font-bold hover:bg-amber-100 transition-all" data-value="5">â­</button>
                    </div>
                    <input type="hidden" id="feedback-rating" value="0">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">What did you like most?</label>
                    <textarea id="feedback-positive" placeholder="e.g., Great speakers, Good timing, Learned a lot..." class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 h-20 resize-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">What could be improved?</label>
                    <textarea id="feedback-improve" placeholder="Your suggestions..." class="w-full p-3 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 h-20 resize-none"></textarea>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeEventFeedbackModal()" class="flex-1 py-3 border border-slate-300 rounded-xl font-bold text-slate-700 hover:bg-slate-50">Skip</button>
                    <button type="submit" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700">Submit Feedback</button>
                </div>
            </form>
        </div>
    </div>

    <div id="resume-view" class="hidden fixed inset-0 z-[300] bg-slate-800 flex flex-col"><div class="h-16 bg-slate-900 flex items-center justify-between px-6 shrink-0"><button onclick="document.getElementById('resume-view').classList.add('hidden')" class="text-slate-400 hover:text-white flex items-center gap-2 font-bold text-sm"><i data-lucide="arrow-left"></i> Exit</button><button onclick="downloadPDF()" class="bg-white text-slate-900 px-4 py-2 rounded font-bold text-sm hover:bg-slate-200">Download PDF</button></div><div class="flex-1 overflow-auto p-8 flex justify-center bg-slate-800"><div id="resume-paper" class="a4-page scale-[0.5] md:scale-[0.8] origin-top"><div class="w-1/3 bg-slate-100 p-8 border-r"><div class="w-32 h-32 bg-slate-300 rounded-full mx-auto mb-6 overflow-hidden"><img id="res-img" class="w-full h-full object-cover hidden"><div class="w-full h-full flex items-center justify-center text-xs font-bold text-slate-500 uppercase cursor-pointer" onclick="document.getElementById('photo-input').click()">Add Photo</div></div><div class="space-y-4 text-sm"><div><h4 class="font-bold uppercase text-xs mb-1 border-b pb-1">Contact</h4><p contenteditable="true">Phone</p><p contenteditable="true">Email</p><p contenteditable="true">City</p></div><div><h4 class="font-bold uppercase text-xs mb-1 border-b pb-1">Skills</h4><ul contenteditable="true" class="list-disc pl-4"><li>Skill 1</li></ul></div></div></div><div class="w-2/3 p-10"><h1 contenteditable="true" class="text-4xl font-serif font-bold mb-2 uppercase text-slate-900">Name</h1><h2 contenteditable="true" class="text-sm font-bold tracking-widest text-blue-600 uppercase mb-8">Role</h2><div class="space-y-6"><div><h3 class="font-serif font-bold text-lg border-b pb-1 mb-2">Profile</h3><p contenteditable="true" class="text-sm text-slate-600">Summary...</p></div><div><h3 class="font-serif font-bold text-lg border-b pb-1 mb-2">Experience</h3><div contenteditable="true" class="text-sm text-slate-600"><p class="font-bold">Role | Company</p><p>Description...</p></div></div><div><h3 class="font-serif font-bold text-lg border-b pb-1 mb-2">Education</h3><div contenteditable="true" class="text-sm text-slate-600"><p class="font-bold">Degree | College</p><p>Year</p></div></div></div></div></div></div><input type="file" id="photo-input" class="hidden" onchange="loadPhoto(this)"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, updateDoc, deleteDoc, query, where, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB0e8-7ohxpLULJ3ZvWtmq9wg99zjDF_js",
            authDomain: "tsdc-portal.firebaseapp.com",
            projectId: "tsdc-portal",
            storageBucket: "tsdc-portal.firebasestorage.app",
            messagingSenderId: "138306273988",
            appId: "1:138306273988:web:dd79c26ae1acf02dee3f91"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let isRegistering = false;
        let activeCertCourseId = null;
        let html5QrcodeScanner = null;
        let dedicatedScanner = null;
        let editingId = null;
        let modalType = null;
        
        window.appData = { resources: [], courses: [], placement: [], events: [] };
        
        const ADMIN_EMAILS = ["master@asadevs.com", "842@asadevs.com", "395@asadevs.com", "617@asadevs.com", "204@asadevs.com", "573@asadevs.com"];
        const SCANNER_EMAILS = ["scanner1@asadevs.com", "scanner2@asadevs.com", "scanner3@asadevs.com"];

        // --- AUTH & LOGIN LOGIC ---
        window.setAuthMode = (mode) => {
            const container = document.getElementById('login-form-container');
            const selector = document.getElementById('role-selector');
            const title = document.getElementById('login-title');
            const sub = document.getElementById('login-subtitle');
            const regHint = document.getElementById('register-hint');
            const emailLabel = document.getElementById('email-label');

            selector.classList.add('hidden');
            container.classList.remove('hidden');

            isRegistering = false;
            document.getElementById('login-hint').classList.add('hidden');
            document.getElementById('auth-btn-text').innerText = "Access Portal";

            if (mode === 'student') {
                title.innerText = "Student Login";
                sub.innerText = "Enter your Student ID";
                emailLabel.innerText = "Student ID";
                regHint.classList.remove('hidden');
                document.getElementById('auth-input').placeholder = "e.g. 202402001";
                document.getElementById('login-type').value = 'student';
            } else {
                title.innerText = "Faculty Login";
                sub.innerText = "Authorized Personnel Only";
                emailLabel.innerText = "Official Email";
                regHint.classList.add('hidden');
                document.getElementById('auth-input').placeholder = "faculty@asadevs.com";
                document.getElementById('login-type').value = 'admin';
            }
        };

        window.resetAuth = () => {
            document.getElementById('login-form-container').classList.add('hidden');
            document.getElementById('role-selector').classList.remove('hidden');
            document.getElementById('auth-input').value = '';
            document.getElementById('auth-pass').value = '';
        };

        window.toggleRegisterMode = () => {
            isRegistering = !isRegistering;
            const title = document.getElementById('login-title');
            const btn = document.getElementById('auth-btn-text');
            const regHint = document.getElementById('register-hint');
            const logHint = document.getElementById('login-hint');

            if (isRegistering) {
                title.innerText = "Student Registration";
                btn.innerText = "Create Account";
                regHint.classList.add('hidden');
                logHint.classList.remove('hidden');
            } else {
                title.innerText = "Student Login";
                btn.innerText = "Access Portal";
                regHint.classList.remove('hidden');
                logHint.classList.add('hidden');
            }
        };

        function isIdAllowed(idStr) {
            const id = parseInt(idStr);
            if (isNaN(id)) return false;
            const bammc = [202310001, 202310003, 202310007, 202310009, 202310010, 202410001, 202410004, 202410005, 202410007, 202410008, 202410009, 202410011, 202410012, 202410014, 202410017, 202410019];
            if (bammc.includes(id)) return true;
            const ranges = [
                [202501001, 202501072], [202401001, 202401073], [202301001, 202301052],
                [202512001, 202512013], [202505001, 202505072], [202505101, 202505172], 
                [2024005001, 2024005072], [2024005101, 2024005171], [202305001, 202305076],
                [202503001, 202503072], [202503101, 202503172], [202403001, 202403074], 
                [202403101, 202403175], [202303001, 202303072], [202303101, 202303136],
                [202513001, 202513024], [202508001, 202508072], [202508101, 202508166], 
                [202408001, 202408160], [202308001, 202308071], [202308103, 202308170], 
                [202308203, 202308251], [202509001, 202509068], [202409001, 202409044], 
                [202309001, 202309022], [202502001, 202502072], [202502101, 202502172], 
                [202502201, 202502260], [202402001, 202402066], [202402101, 202402165], 
                [202402201, 202402266], [202302001, 202302072], [202302101, 202302184]
            ];
            return ranges.some(r => id >= r[0] && id <= r[1]);
        }

        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('global-loader');
            if (user) {
                // Determine Role
                let role = 'student';
                if (ADMIN_EMAILS.includes(user.email)) role = 'admin';
                if (SCANNER_EMAILS.includes(user.email)) role = 'scanner';

                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    currentUser = { ...docSnap.data(), uid: user.uid, email: user.email, role: role };
                    loginSuccess(currentUser);
                } else {
                    // Auto-create profile for special roles if missing
                    if (role !== 'student') {
                        const profileData = { name: role === 'admin' ? "Faculty Admin" : "Security Officer", dept: "Staff", year: "N/A", bio: "Staff", email: user.email };
                        await setDoc(docRef, profileData);
                        currentUser = { ...profileData, uid: user.uid, role: role };
                        loginSuccess(currentUser);
                    } else {
                        // Regular student onboarding
                        document.getElementById('auth-view').classList.add('hidden');
                        document.getElementById('onboarding-modal').classList.remove('hidden');
                    }
                }
            } else {
                // LOGOUT CLEANUP
                if(dedicatedScanner) { dedicatedScanner.stop().catch(e=>console.log(e)); dedicatedScanner = null; }
                document.getElementById('app-interface').classList.add('hidden');
                document.getElementById('scanner-interface').classList.add('hidden'); // Hide scanner view
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('mobile-menu').classList.add('hidden'); 
                document.getElementById('login-form-container').classList.add('hidden');
                document.getElementById('role-selector').classList.remove('hidden');
                document.getElementById('auth-input').value = '';
                document.getElementById('auth-pass').value = '';
                currentUser = null;
            }
            loader.classList.add('hidden');
        });

        window.handleLoginSubmit = async (e) => {
            e.preventDefault();
            const inputVal = document.getElementById('auth-input').value.trim();
            const pass = document.getElementById('auth-pass').value;
            const loginType = document.getElementById('login-type').value;

            if(!inputVal || !pass) return Toastify({text: "Enter details", style: {background: "#ef4444"}}).showToast();
            
            let email = inputVal;

            if (loginType === 'student') {
                // For students, ensure it's a number and valid
                if (!/^\d+$/.test(inputVal)) {
                    return Toastify({text: "Please enter a valid numeric Student ID", style: {background: "#ef4444"}}).showToast();
                }
                if (!isIdAllowed(inputVal)) {
                    return Toastify({text: "Invalid Student ID. Access Denied.", style: {background: "#ef4444"}}).showToast();
                }
                // Construct the email automatically
                email = `${inputVal}@asadevs.com`;
            } 
            else if (loginType === 'admin') {
                // For admin/scanner, use the full email entered
                // Optional: Check if email is in allowed lists for earlier feedback
                if (!ADMIN_EMAILS.includes(inputVal) && !SCANNER_EMAILS.includes(inputVal)) {
                    // We let it pass to firebase to handle authentication errors, or we can block here
                    // Keeping it flexible for now, but ensure user types full email
                    if(!inputVal.includes('@')) {
                         return Toastify({text: "Please enter full email address", style: {background: "#ef4444"}}).showToast();
                    }
                }
                email = inputVal;
            }

            try {
                if(isRegistering && loginType === 'student') {
                    await createUserWithEmailAndPassword(auth, email, pass);
                    Toastify({text: "Account Created!", style: {background: "#10b981"}}).showToast();
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                    Toastify({text: "Logged In", style: {background: "#10b981"}}).showToast();
                }
            } catch (error) { Toastify({text: "Login Failed: Check ID/Email & Password", style: {background: "#ef4444"}}).showToast(); console.error(error); }
        };

        window.handleLogout = async () => {
            const logoutBtn = document.querySelector('[onclick="handleLogout()"]');
            if(logoutBtn) {
                logoutBtn.disabled = true;
                logoutBtn.style.opacity = '0.5';
            }
            
            try {
                // Clear scanner mode immediately
                document.body.classList.remove('scanner-mode');
                document.getElementById('scanner-interface').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                
                // Reset scan counter
                document.getElementById('scan-counter').textContent = 'Scans: 0';
                window.scanCounter = 0;
                
                // Perform logout
                await signOut(auth);
                
                // Refresh page to show login screen
                setTimeout(() => window.location.reload(), 500);
            } catch (error) {
                console.error('Logout error:', error);
                if(logoutBtn) {
                    logoutBtn.disabled = false;
                    logoutBtn.style.opacity = '1';
                }
                Toastify({text: "Logout Error: " + error.message, style: {background: "#ef4444"}}).showToast();
            }
        };
        
        window.saveProfileData = async () => {
            const user = auth.currentUser;
            if(!user) return;
            const name = document.getElementById('ob-name').value;
            const dept = document.getElementById('ob-dept').value;
            const year = document.getElementById('ob-year').value;
            if(!name) return alert("Name required");
            await setDoc(doc(db, "users", user.uid), { name, dept, year, bio: "Ready to learn.", email: user.email });
            location.reload(); 
        };

        function loginSuccess(user) {
            document.getElementById('auth-view').classList.add('hidden');
            
            // --- ROUTING LOGIC ---
            if (user.role === 'scanner') {
                // SCANNER MODE - COMPLETE LOCKDOWN
                document.body.classList.add('scanner-mode');
                document.getElementById('app-interface').classList.add('hidden'); 
                document.getElementById('scanner-interface').classList.remove('hidden'); 
                document.getElementById('mobile-menu').style.display = 'none';
                
                // Prevent any potential navigation
                document.addEventListener('keydown', preventScannerNavigation);
                
                setTimeout(initDedicatedScanner, 500); // Wait for DOM to settle
            } else {
                // STANDARD DASHBOARD
                document.body.classList.remove('scanner-mode');
                document.getElementById('scanner-interface').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                document.body.classList.toggle('is-admin', user.role === 'admin');
                
                document.getElementById('sb-name').innerText = user.name;
                document.getElementById('sb-avatar').innerText = user.name[0];
                document.getElementById('home-name').innerText = user.name;
                document.getElementById('prof-name').innerText = user.name;
                document.getElementById('prof-meta').innerText = user.role === 'admin' ? 'Administrator' : `${user.dept} â€¢ ${user.year}`;
                document.getElementById('prof-bio').innerText = user.bio || '';
                navTo('home');
                loadData();
            }
        }
        
        // Prevent scanner users from navigating away via keyboard shortcuts
        function preventScannerNavigation(e) {
            if(!document.body.classList.contains('scanner-mode')) return;
            
            // Block navigation keys (Alt, Ctrl+N, Cmd+W, etc)
            if (e.altKey || (e.ctrlKey && (e.key === 'n' || e.key === 'w')) || (e.metaKey && e.key === 'w')) {
                e.preventDefault();
            }
        }

        async function loadData() {
            if(currentUser.role === 'scanner') return; // Security: Don't load data for scanners
            renderCollection('resources');
            renderCollection('courses');
            renderCollection('placement');
            renderCollection('events');
            if(currentUser.role === 'student') loadActivity();
        }

        // --- DEDICATED SCANNER LOGIC ---
        window.initDedicatedScanner = () => {
            if(dedicatedScanner) return;
            // Ensure element exists and is visible
            const readerEl = document.getElementById("dedicated-reader");
            if(!readerEl || readerEl.offsetParent === null) {
                console.error("Scanner element hidden or missing");
                return; 
            }

            const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
            dedicatedScanner = new Html5Qrcode("dedicated-reader");
            dedicatedScanner.start({ facingMode: "environment" }, config, 
                async (decodedText) => {
                    dedicatedScanner.pause();
                    await processTicket(decodedText);
                },
                (err) => { }
            ).catch(err => { 
                console.error(err);
                alert("Camera Access Denied or Error. Please allow camera permissions and reload."); 
            });
        };

        window.resetScannerUI = () => {
            document.getElementById('scan-status-panel').classList.add('translate-y-full');
            if(dedicatedScanner) dedicatedScanner.resume();
        };

        async function processTicket(qrString) {
            const panel = document.getElementById('scan-status-panel');
            const icon = document.getElementById('status-icon');
            const title = document.getElementById('status-title');
            const desc = document.getElementById('status-desc');
            const details = document.getElementById('student-details');
            
            const setStatus = (type, mainTitle, subDesc, showDetails = false) => {
                if(type === 'success') { icon.className = "w-20 h-20 rounded-full flex items-center justify-center mb-6 text-white shadow-xl text-4xl border-2 bg-emerald-500 border-emerald-400"; icon.innerHTML = '<i data-lucide="check"></i>'; }
                if(type === 'error') { icon.className = "w-20 h-20 rounded-full flex items-center justify-center mb-6 text-white shadow-xl text-4xl border-2 bg-red-500 border-red-400"; icon.innerHTML = '<i data-lucide="x"></i>'; }
                if(type === 'warn') { icon.className = "w-20 h-20 rounded-full flex items-center justify-center mb-6 text-white shadow-xl text-4xl border-2 bg-amber-500 border-amber-400"; icon.innerHTML = '<i data-lucide="alert-triangle"></i>'; }
                
                title.innerText = mainTitle;
                desc.innerText = subDesc;
                details.classList.toggle('hidden', !showDetails);
                panel.classList.remove('translate-y-full'); 
                lucide.createIcons();
            };

            const parts = qrString.split('::');
            if(parts.length !== 2) {
                setStatus('error', 'Invalid Format', 'This QR code is not recognized.');
                return;
            }

            const uid = parts[0];
            const eventId = parts[1];

            try {
                const q = query(collection(db, "event_registrations"), where("uid", "==", uid), where("eventId", "==", eventId));
                const snap = await getDocs(q);

                if(snap.empty) {
                    setStatus('error', 'Access Denied', 'No registration found for this event.');
                } else {
                    const docSnap = snap.docs[0];
                    const data = docSnap.data();

                    document.getElementById('sd-name').innerText = data.studentName;
                    document.getElementById('sd-id').innerText = data.studentId;

                    if (data.attended) {
                        setStatus('warn', 'Already Scanned', `Scanned on: ${new Date(data.scannedAt || Date.now()).toLocaleTimeString()}`, true);
                    } else {
                        await updateDoc(doc(db, "event_registrations", docSnap.id), { 
                            attended: true,
                            scannedAt: new Date().toISOString(),
                            scannedBy: currentUser.email
                        });
                        setStatus('success', 'Access Granted', 'Ticket verified successfully.', true);
                        // Increment scan counter
                        incrementScanCounter();
                    }
                }
            } catch (error) {
                console.error(error);
                setStatus('error', 'System Error', 'Could not verify ticket. Check internet.');
            }
        }
        
        // Scanner counter tracking
        let scanSessionCount = 0;
        function incrementScanCounter() {
            scanSessionCount++;
            document.getElementById('scan-counter').innerText = `Scans: ${scanSessionCount}`;
        }

        async function loadActivity() {
            const eventList = document.getElementById('my-events-list');
            const courseList = document.getElementById('my-courses-list');
            
            // 1. Events
            const qEvents = query(collection(db, "event_registrations"), where("uid", "==", currentUser.uid));
            const snapEvents = await getDocs(qEvents);
            eventList.innerHTML = snapEvents.empty ? '<p class="text-sm text-slate-400">No events registered.</p>' : '';
            snapEvents.forEach(d => {
                const ev = d.data();
                const safeName = ev.eventName.replace(/'/g, "\\'");
                eventList.innerHTML += `<div class="p-3 border rounded-xl flex justify-between items-center mb-2"><span class="font-bold text-sm">${ev.eventName}</span><button onclick="window.showTicket('${ev.eventId}', '${safeName}')" class="text-xs bg-slate-900 text-white px-3 py-1.5 rounded-lg">View QR</button></div>`;
            });

            // 2. Active & Completed Courses
            courseList.innerHTML = '';
            const qEnrolled = query(collection(db, "course_enrollments"), where("uid", "==", currentUser.uid));
            const snapEnrolled = await getDocs(qEnrolled);
            
            const qCompleted = query(collection(db, "course_completions"), where("uid", "==", currentUser.uid));
            const snapCompleted = await getDocs(qCompleted);

            const completedIds = snapCompleted.docs.map(d => d.data().courseId);

            if (!snapEnrolled.empty) {
                snapEnrolled.forEach(d => {
                    const data = d.data();
                    if (!completedIds.includes(data.courseId)) {
                        const courseInfo = window.appData.courses.find(c => c.id === data.courseId);
                        const title = courseInfo ? courseInfo.title : "Active Course";
                        courseList.innerHTML += `<div class="p-3 border rounded-xl border-blue-100 bg-blue-50 text-blue-800 text-sm font-bold flex justify-between items-center mb-2"><span>${title}</span> <span class="text-[10px] uppercase bg-white px-2 py-1 rounded">In Progress</span></div>`;
                    }
                });
            }

            if (!snapCompleted.empty) {
                snapCompleted.forEach(d => {
                    const courseInfo = window.appData.courses.find(c => c.id === d.data().courseId);
                    const title = courseInfo ? courseInfo.title : "Course";
                    courseList.innerHTML += `<div class="p-3 border rounded-xl border-green-100 bg-green-50 text-green-800 text-sm font-bold flex items-center mb-2"><i data-lucide="check" class="w-4 h-4 mr-2"></i> ${title} - Completed</div>`;
                });
            }

            if (courseList.innerHTML === '') courseList.innerHTML = '<p class="text-sm text-slate-400">No active or completed courses.</p>';
            lucide.createIcons();
        }

        // --- NEW SHOW TICKET FUNCTION ---
        window.showTicket = (id, name) => {
            const studentID = currentUser.email.split('@')[0];
            const eventData = window.appData.events.find(e => e.id === id);
            
            // Populate Ticket Data
            document.getElementById('t-event-name').innerText = name;
            document.getElementById('t-student').innerText = currentUser.name;
            document.getElementById('t-id').innerText = `ID: ${studentID}`;
            document.getElementById('t-date-text').innerText = eventData ? eventData.date : 'TBA';
            document.getElementById('t-loc-text').innerText = eventData ? eventData.location : 'Campus';
            
            // Generate QR
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: `${currentUser.uid}::${id}`, width: 100, height: 100 });
            
            // Show Modal
            document.getElementById('ticket-modal').classList.remove('hidden');
        };

        window.startCourse = async (courseId, link) => {
            window.open(link, '_blank');
            const q = query(collection(db, "course_enrollments"), where("uid", "==", currentUser.uid), where("courseId", "==", courseId));
            const snap = await getDocs(q);
            if(snap.empty) {
                await addDoc(collection(db, "course_enrollments"), { 
                    uid: currentUser.uid, 
                    courseId: courseId, 
                    timestamp: new Date().toISOString() 
                });
                renderCollection('courses'); 
                if(currentUser.role === 'student') loadActivity(); 
                Toastify({text: "Course Started!", style: {background: "#10b981"}}).showToast();
            }
        };

        window.filterGrid = (gridId, text) => {
            const grid = document.getElementById(gridId);
            const cards = grid.getElementsByClassName('grid-item');
            Array.from(cards).forEach(card => {
                const title = card.querySelector('h3').innerText.toLowerCase();
                card.style.display = title.includes(text.toLowerCase()) ? "flex" : "none"; 
            });
        };

        async function renderCollection(colName) {
            const grid = document.getElementById(`grid-${colName}`);
            grid.innerHTML = '<div class="col-span-full text-center text-slate-500 font-bold bg-white/50 p-4 rounded-xl">Loading...</div>';
            
            const querySnapshot = await getDocs(collection(db, colName));
            let items = [];
            querySnapshot.forEach((doc) => items.push({ id: doc.id, ...doc.data() }));
            
            window.appData[colName] = items;

            let completions = [];
            let enrollments = [];
            if(colName === 'courses' && currentUser.role === 'student') {
                const qComp = query(collection(db, "course_completions"), where("uid", "==", currentUser.uid));
                const csComp = await getDocs(qComp);
                csComp.forEach(d => completions.push(d.data().courseId));

                const qEnr = query(collection(db, "course_enrollments"), where("uid", "==", currentUser.uid));
                const csEnr = await getDocs(qEnr);
                csEnr.forEach(d => enrollments.push(d.data().courseId));
            }

            if(colName === 'resources') document.getElementById('stat-res').innerText = items.length;
            if(colName === 'courses') document.getElementById('stat-course').innerText = items.length;
            if(colName === 'placement') document.getElementById('stat-job').innerText = items.length;

            grid.innerHTML = '';
            if(!items.length) { grid.innerHTML = `<div class="col-span-full text-center py-12 text-slate-500 font-medium bg-white/60 border-2 border-dashed border-slate-300 rounded-xl">No ${colName} found.</div>`; return; }

            items.forEach((item) => {
                const adminBtns = currentUser.role === 'admin' ? `
                    <div class="absolute top-3 right-3 flex gap-2 z-10">
                        <button onclick="window.editItem('${colName}', '${item.id}')" class="text-blue-400 hover:text-blue-600 bg-white p-1 rounded-full shadow-sm hover:scale-110"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button onclick="window.deleteItem('${colName}', '${item.id}')" class="text-red-400 hover:text-red-600 bg-white p-1 rounded-full shadow-sm hover:scale-110"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>` : '';
                
                let content = '';

                if(colName === 'resources') {
                    const isFile = item.link.startsWith('data:');
                    const linkAction = isFile ? `href="${item.link}" download="${item.title}"` : `href="${item.link}" target="_blank"`;
                    content = `<div class="grid-item card-3d bg-white/90 backdrop-blur-sm p-5 rounded-xl border border-white/50 shadow-3d relative glow-on-hover hover:border-blue-400">${adminBtns}<div class="flex items-center gap-3 mb-2"><div class="p-2 bg-blue-50 text-blue-600 rounded-lg transition-transform hover:rotate-6"><i data-lucide="file-text" class="w-5 h-5"></i></div><span class="text-xs font-bold bg-slate-100 px-2 py-1 rounded text-slate-500">${item.cat}</span></div><h3 class="font-bold text-lg mb-1">${item.title}</h3><p class="text-sm text-slate-500 mb-4 line-clamp-2">${item.desc}</p><a ${linkAction} class="text-blue-600 text-sm font-bold hover:underline transition-all hover:translate-x-1">View Resource</a></div>`;
                }
                else if (colName === 'courses') {
                     const bg = item.image ? `background-image: url('${item.image}');` : `background: #1e293b;`;
                     const isCompleted = completions.includes(item.id);
                     const isEnrolled = enrollments.includes(item.id);
                     const completedStyle = isCompleted ? 'border-green-500 border-2' : 'border-white/50';
                     const badgeColor = item.mode === 'Online' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700';
                     const costBadge = item.cost === 'Paid' ? 'bg-yellow-100 text-yellow-700 border-yellow-200' : 'bg-blue-100 text-blue-700 border-blue-200';
                     const costText = item.cost || 'Free';
                     
                     let actions = '';
                     if(currentUser.role === 'student') {
                        if (isCompleted) {
                            actions = `<div class="mt-3 bg-green-50 text-green-600 py-2 rounded-lg text-sm font-bold text-center flex items-center justify-center gap-2 animate-pulse"><i data-lucide="check-circle" class="w-4 h-4"></i> Completed</div>`;
                        } else if (isEnrolled) {
                            actions = `<div class="mt-3"><div class="flex gap-2"><button onclick="triggerCertUpload('${item.id}')" class="flex-1 bg-blue-50 text-blue-600 py-2 rounded-lg text-xs font-bold hover:bg-blue-100 transition-all transform hover:scale-105">Upload Cert</button><button onclick="discontinueCourse('${item.id}', this)" class="w-1/3 bg-red-50 text-red-500 py-2 rounded-lg text-xs font-bold hover:bg-red-100 transition-all transform hover:scale-105">Drop</button></div><a href="${item.link}" target="_blank" class="block text-center mt-2 text-xs text-slate-400 hover:text-slate-600 hover:underline">Continue Learning &rarr;</a></div>`;
                        } else {
                            let btnColor = (item.cost === 'Paid') ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-slate-900 hover:bg-slate-800';
                            let btnText = (item.cost === 'Paid') ? 'Enroll Now' : 'Start Course';
                            let targetLink = (item.cost === 'Paid' && item.paymentUrl) ? item.paymentUrl : item.link;
                            actions = `<div class="mt-3"><button onclick="openCourseModal('${item.id}', '${item.title}', '${item.desc}', '${item.link}', '${item.cost || 'Free'}')" class="block text-center w-full ${btnColor} text-white py-2 rounded-lg text-sm font-bold transition-all transform hover:scale-105 active:scale-95 mb-2">${btnText}</button></div>`;
                        }
                     }
                     content = `<div class="grid-item card-3d bg-white/90 backdrop-blur-sm rounded-xl border shadow-sm relative flex flex-col overflow-hidden ${completedStyle}" id="course-card-${item.id}">${adminBtns}<div class="h-32 bg-cover bg-center bg-slate-800 transform transition-transform hover:scale-110" style="${bg}"><span class="absolute top-2 right-2 border ${costBadge} text-[10px] font-bold uppercase px-2 py-1 rounded shadow-sm z-10">${costText}</span></div><div class="p-5 flex-1 flex flex-col"><div class="flex justify-between items-start mb-2"><h3 class="font-bold text-lg leading-tight">${item.title}</h3><span class="text-[10px] font-bold uppercase px-2 py-1 rounded ${badgeColor} transform transition-transform hover:scale-110">${item.mode || 'Online'}</span></div><p class="text-sm text-slate-500 mb-4 flex-1">${item.desc}</p>${actions}</div></div>`;
                }
                else if (colName === 'placement') {
                    const isInternship = item.role.toLowerCase().includes('intern');
                    const badgeText = isInternship ? 'Internship' : 'Full-Time';
                    const badgeColor = isInternship ? 'text-purple-600 bg-purple-50' : 'text-blue-600 bg-blue-50';

                    content = `
                    <div class="grid-item bg-white p-5 rounded-[2rem] border border-slate-100 shadow-sm mb-4 relative hover:shadow-md transition-all">
                        ${adminBtns}
                        
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-16 h-16 rounded-2xl bg-slate-50 flex items-center justify-center border border-slate-100 shrink-0 overflow-hidden">
                                ${item.image ? `<img src="${item.image}" loading="lazy" class="w-full h-full object-cover">` : `<i data-lucide="briefcase" class="text-slate-300 w-8 h-8"></i>`}
                            </div>
                            <div class="min-w-0">
                                <span class="px-2.5 py-1 rounded-full text-[10px] font-black uppercase ${badgeColor}">${badgeText}</span>
                                <h3 class="text-xl font-bold text-slate-900 truncate mt-1">${item.role}</h3>
                                <p class="text-sm font-medium text-slate-500 flex items-center gap-1">
                                    <i data-lucide="building-2" class="w-3.5 h-3.5"></i> ${item.company}
                                </p>
                            </div>
                        </div>

                        <div class="bg-slate-50/50 rounded-2xl p-4 grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="info-label">Monthly Pay</p>
                                <p class="text-sm font-bold text-slate-700">${item.pay || 'As per norms'}</p>
                            </div>
                            <div>
                                <p class="info-label">Work Type</p>
                                <p class="text-sm font-bold text-slate-700">Hybrid / Office</p>
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="openPlacementModal('${item.id}', '${item.role}', '${item.company}', '${item.pay || 'As per norms'}')" 
                               class="btn-tap flex-[2] bg-blue-600 text-white flex items-center justify-center gap-2 py-4 rounded-2xl font-bold text-sm shadow-lg shadow-blue-200">
                               <i data-lucide="send" class="w-4 h-4"></i> Apply Now
                            </button>
                            
                            <a href="tel:9619112464" 
                               class="btn-tap flex-1 bg-slate-100 text-slate-600 flex items-center justify-center py-4 rounded-2xl font-bold text-sm">
                               <i data-lucide="phone" class="w-4 h-4"></i>
                            </a>
                        </div>
                        
                        <div class="mt-3 flex justify-center">
                            <p class="text-[11px] text-slate-400 font-medium flex items-center gap-1">
                                <i data-lucide="clock" class="w-3 h-3 text-orange-400"></i> Usually responds in 2 days
                            </p>
                        </div>
                    </div>`;
                }
                else if (colName === 'events') {
                    const currentCount = item.count || 0;
                    const limit = item.limit || 100;
                    const bgStyle = item.image ? `background-image: url('${item.image}'); background-size: cover; background-position: center;` : `background: linear-gradient(to right, #1e293b, #334155);`;
                    const safeName = (item.name || '').replace(/'/g, "\\'"); 
                    const safeId = item.id;
                    let btn = '';
                    if(currentUser.role === 'student') btn = `<button onclick="openEventModal('${safeId}', '${safeName}', '${item.date}', '${item.location}', '${item.desc || ''}', '${item.image || ''}', ${currentCount}, ${limit})" class="w-full bg-slate-100 py-2 rounded-lg text-sm font-bold hover:bg-slate-200 transition-all transform hover:scale-105 active:scale-95">Register</button>`;
                    else if (currentUser.role === 'admin') btn = `
                    <div class="flex flex-col gap-2 mt-2">
                        <button onclick="window.exportEventData('${safeId}', '${safeName}')" class="w-full bg-slate-100 text-slate-700 py-2 rounded-lg text-xs font-bold hover:bg-slate-200 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Registration List
                        </button>
                        <button onclick="window.exportAttendanceData('${safeId}', '${safeName}')" class="w-full bg-green-100 text-green-700 py-2 rounded-lg text-xs font-bold hover:bg-green-200 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="check-circle" class="w-3 h-3"></i> Attendance Report
                        </button>
                    </div>
                    `;
                    const clickAction = item.image ? `onclick="viewImage('${item.image}')"` : '';
                    const cursorClass = item.image ? 'cursor-zoom-in' : '';
                    content = `<div class="grid-item card-3d bg-white/90 backdrop-blur-sm rounded-xl border border-white/50 shadow-3d overflow-hidden relative group glow-on-hover hover:border-blue-400">${adminBtns}<div ${clickAction} class="h-32 flex items-center justify-center text-white/30 font-bold text-xl relative transform transition-transform hover:scale-110 ${cursorClass}" style="${bgStyle}"></div><div class="p-4"><h3 class="font-bold text-lg">${item.name}</h3><p class="text-xs text-slate-500 mb-3 line-clamp-2">${item.desc || ''}</p><div class="text-sm text-slate-500 mb-3 space-y-1"><p><i data-lucide="map-pin" class="w-3 h-3 inline mr-1"></i> ${item.location || 'TBA'}</p><p><i data-lucide="calendar" class="w-3 h-3 inline mr-1"></i> ${item.date}</p></div>${btn}</div></div>`;
                }
                grid.innerHTML += content;
            });
            lucide.createIcons();
        }

        window.viewImage = (url) => { if(url) { document.getElementById('full-image').src = url; document.getElementById('image-viewer').classList.remove('hidden'); } };
        window.closeImageView = () => document.getElementById('image-viewer').classList.add('hidden');

        window.deleteItem = async (colName, id) => {
            if(!confirm("Delete from cloud?")) return;
            await deleteDoc(doc(db, colName, id));
            renderCollection(colName);
        };

        window.editItem = (col, id) => {
            editingId = id; 
            const item = window.appData[col].find(i => i.id === id);
            if (!item) return;
            openModal(col); 
            
            document.getElementById('modal-title').innerText = "Edit Item";
            document.getElementById('modal-save').innerText = "Update Cloud";
            
            setTimeout(() => {
                if(col === 'resources') {
                    document.getElementById('i1').value = item.title;
                    document.getElementById('i2').value = item.cat;
                    document.getElementById('i3').value = item.link;
                    document.getElementById('i4').value = item.desc;
                } else if(col === 'courses') {
                    document.getElementById('i1').value = item.title;
                    document.getElementById('i2').value = item.desc;
                    document.getElementById('i3').value = item.mode;
                    document.getElementById('i4').value = item.link;
                    document.getElementById('i5').value = item.image;
                    document.getElementById('i6').value = item.cost || 'Free';
                    togglePaymentField(item.cost || 'Free');
                    document.getElementById('i7').value = item.paymentUrl || '';
                } else if(col === 'placement') {
                    document.getElementById('i1').value = item.role;
                    document.getElementById('i2').value = item.company;
                    document.getElementById('i3').value = item.pay;
                    document.getElementById('i4').value = item.image;
                } else if(col === 'events') {
                    document.getElementById('i1').value = item.name;
                    document.getElementById('i2').value = item.date.replace(' ', 'T');
                    document.getElementById('i3').value = item.location;
                    document.getElementById('i4').value = item.image;
                    document.getElementById('i5').value = item.limit;
                    document.getElementById('i6').value = item.desc;
                }
            }, 100);
        };

        window.joinEvent = async (id, name, count, limit) => {
            if(count >= limit) return alert("Event is Full");
            const q = query(collection(db, "event_registrations"), where("eventId", "==", id), where("uid", "==", currentUser.uid));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) return alert("You are already registered for this event.");
            const eventRef = doc(db, "events", id);
            await updateDoc(eventRef, { count: increment(1) });
            const studentID = currentUser.email.split('@')[0]; 
            await addDoc(collection(db, "event_registrations"), {
                eventId: id, eventName: name, uid: currentUser.uid, studentName: currentUser.name, studentId: studentID, dept: currentUser.dept || "N/A", year: currentUser.year || "N/A", timestamp: new Date().toISOString()
            });
            renderCollection("events");
            window.showTicket(id, name);
            Toastify({text: "Registered Successfully!", style: {background: "#10b981"}}).showToast();
        };

        // --- EXPORT 1: REGISTRATION LIST (ALL) ---
        window.exportEventData = async (eventId, eventName) => {
            if (currentUser.role !== 'admin') return;
            Toastify({text: "Fetching Registrations...", style: {background: "#3b82f6"}}).showToast();
            try {
                const q = query(collection(db, "event_registrations"), where("eventId", "==", eventId));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) return alert("No registrations yet.");
                
                let csvContent = "Student ID,Full Name,Department,Year,Registration Date\n"; 
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = new Date(data.timestamp).toLocaleDateString();
                    const row = `"${data.studentId}","${data.studentName}","${data.dept}","${data.year}","${date}"`;
                    csvContent += row + "\n";
                });
                
                downloadCSV(csvContent, `${eventName.replace(/[^a-z0-9]/gi, '_')}_REGISTRATIONS.csv`);
            } catch (error) { alert("Failed to export data: " + error.message); }
        };

        // --- EXPORT 2: ATTENDANCE REPORT (SCANNED ONLY) ---
        window.exportAttendanceData = async (eventId, eventName) => {
            if (currentUser.role !== 'admin') return;
            Toastify({text: "Fetching Attendance...", style: {background: "#16a34a"}}).showToast();
            try {
                const q = query(collection(db, "event_registrations"), where("eventId", "==", eventId));
                const querySnapshot = await getDocs(q);
                
                // Filter for attended only
                const attendees = querySnapshot.docs.filter(doc => doc.data().attended === true);

                if (attendees.length === 0) return alert("No students have been scanned for this event yet.");
                
                let csvContent = "Student ID,Full Name,Department,Year,Scan Time,Scanned By\n";
                
                attendees.forEach((doc) => {
                    const data = doc.data();
                    const scanTime = data.scannedAt ? new Date(data.scannedAt).toLocaleString() : "Manual Entry";
                    const scanner = data.scannedBy || "System";
                    const row = `"${data.studentId}","${data.studentName}","${data.dept}","${data.year}","${scanTime}","${scanner}"`;
                    csvContent += row + "\n";
                });

                downloadCSV(csvContent, `${eventName.replace(/[^a-z0-9]/gi, '_')}_ATTENDANCE.csv`);
            } catch (error) { alert("Error: " + error.message); }
        };

        // Helper for CSV Download
        function downloadCSV(csvContent, fileName) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.triggerCertUpload = (courseId) => {
            activeCertCourseId = courseId;
            document.getElementById('cert-upload-input').click();
        };

        document.getElementById('cert-upload-input').addEventListener('change', async (e) => {
            if (e.target.files && e.target.files[0] && activeCertCourseId) {
                await addDoc(collection(db, "course_completions"), { uid: currentUser.uid, courseId: activeCertCourseId, date: new Date().toISOString() });
                Toastify({text: "Certificate Uploaded!", style: {background: "#10b981"}}).showToast();
                renderCollection('courses');
                if(currentUser.role === 'student') loadActivity(); 
                activeCertCourseId = null;
            }
        });

        window.discontinueCourse = async (courseId, btn) => {
            if(confirm("Are you sure you want to drop this course?")) {
                const q = query(collection(db, "course_enrollments"), where("uid", "==", currentUser.uid), where("courseId", "==", courseId));
                const snap = await getDocs(q);
                snap.forEach(async (d) => await deleteDoc(doc(db, "course_enrollments", d.id)));
                
                const card = document.getElementById(`course-card-${courseId}`);
                if(card) card.style.opacity = '0.5';
                if(btn) btn.parentElement.innerHTML = '<span class="text-xs text-red-400 font-bold">Dropped</span>';
                
                Toastify({text: "Course Dropped", style: {background: "#64748b"}}).showToast();
                setTimeout(() => {
                    renderCollection('courses');
                    if(currentUser.role === 'student') loadActivity();
                }, 1000);
            }
        };

        window.handleBioUpdate = async () => {
            const bio = document.getElementById('prof-bio').innerText;
            const userRef = doc(db, "users", currentUser.uid);
            await updateDoc(userRef, { bio: bio });
            Toastify({text: "Bio Saved", style: {background: "#10b981"}}).showToast();
        };

        window.togglePaymentField = (val) => {
            const field = document.getElementById('i7');
            if (val === 'Paid') { field.classList.remove('hidden-important'); field.classList.remove('hidden'); field.focus(); } 
            else { field.classList.add('hidden-important'); field.value = ''; }
        };

        window.startScanner = () => {
            document.getElementById('scanner-modal').classList.remove('hidden');
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
                async (decodedText) => {
                    const parts = decodedText.split('::');
                    if(parts.length === 2) {
                        html5QrcodeScanner.stop();
                        document.getElementById('scanner-modal').classList.add('hidden');
                        
                        const q = query(collection(db, "event_registrations"), where("uid", "==", parts[0]), where("eventId", "==", parts[1]));
                        const snap = await getDocs(q);
                        if(!snap.empty) {
                            const docId = snap.docs[0].id;
                            await updateDoc(doc(db, "event_registrations", docId), { attended: true });
                            Toastify({text: "Attendance Marked!", style: {background: "#10b981"}}).showToast();
                        } else {
                            Toastify({text: "Invalid Ticket", style: {background: "#ef4444"}}).showToast();
                        }
                    }
                },
                (errorMessage) => { }
            ).catch(err => { console.log(err); });
        };
        window.stopScanner = () => {
            if(html5QrcodeScanner) html5QrcodeScanner.stop().then(() => document.getElementById('scanner-modal').classList.add('hidden'));
            else document.getElementById('scanner-modal').classList.add('hidden');
        };

        window.openModal = (type) => {
            modalType = type;
            editingId = null; 
            const f = document.getElementById('modal-fields');
            const t = document.getElementById('modal-title');
            document.getElementById('modal-save').innerText = "Save to Cloud"; 
            const inp = "w-full p-3 border rounded-xl text-sm bg-slate-50 outline-none focus:ring-2 focus:ring-blue-500 mb-3";
            const fileInput = document.getElementById('unified-file-input');
            fileInput.value = '';
            
            if(type === 'resources') { t.innerText="Add Resource"; f.innerHTML=`<input id="i1" placeholder="Title" class="${inp}"><input id="i2" placeholder="Category" class="${inp}"><div class="flex gap-2 mb-3"><input id="i3" placeholder="Link/File" class="${inp} mb-0"><button onclick="document.getElementById('unified-file-input').click()" class="bg-slate-200 px-3 rounded-xl text-xs font-bold whitespace-nowrap">Upload</button></div><textarea id="i4" placeholder="Description" class="${inp} h-24"></textarea>`; }
            if(type === 'courses') { 
                t.innerText="Add Course Training"; 
                f.innerHTML=`<input id="i1" placeholder="Course Name" class="${inp}"><input id="i2" placeholder="Description" class="${inp}"><div class="flex gap-2 mb-3"><select id="i3" class="${inp} mb-0"><option>Online</option><option>Offline</option></select><select id="i6" class="${inp} mb-0" onchange="togglePaymentField(this.value)"><option value="Free">Free</option><option value="Paid">Paid</option></select></div><input id="i7" placeholder="Payment URL" class="${inp} hidden-important"><input id="i4" placeholder="Course Content Link" class="${inp}"><div class="flex gap-2 mb-3"><input id="i5" placeholder="Image URL" class="${inp} mb-0"><button onclick="document.getElementById('unified-file-input').click()" class="bg-slate-200 px-3 rounded-xl text-xs font-bold whitespace-nowrap">Upload</button></div>`; 
            }
            if(type === 'placement') { t.innerText="Post Job"; f.innerHTML=`<input id="i1" placeholder="Role" class="${inp}"><input id="i2" placeholder="Company" class="${inp}"><input id="i3" placeholder="Pay" class="${inp}"><div class="flex gap-2 mb-3"><input id="i4" placeholder="Logo URL" class="${inp} mb-0"><button onclick="document.getElementById('unified-file-input').click()" class="bg-slate-200 px-3 rounded-xl text-xs font-bold whitespace-nowrap">Upload</button></div>`; }
            if(type === 'events') { 
                t.innerText="Create Event/Seminar"; 
                f.innerHTML=`<input id="i1" placeholder="Name" class="${inp}"><div class="flex gap-2"><input type="datetime-local" id="i2" class="${inp}"><input id="i3" placeholder="Loc" class="${inp}"></div><div class="flex gap-2"><input type="number" id="i5" placeholder="Limit" class="${inp}"></div><textarea id="i6" placeholder="Description" class="${inp} h-24"></textarea><div class="flex gap-2 mb-3"><input id="i4" placeholder="Banner URL" class="${inp} mb-0"><button onclick="document.getElementById('unified-file-input').click()" class="bg-slate-200 px-3 rounded-xl text-xs font-bold whitespace-nowrap">Upload</button></div>`; 
            }
            document.getElementById('data-modal').classList.remove('hidden');
        };

        document.getElementById('modal-save').addEventListener('click', async () => {
            const i1 = document.getElementById('i1').value;
            if(!i1) return;
            let obj = {};
            if(modalType === 'resources') obj = { title: i1, cat: document.getElementById('i2').value, link: document.getElementById('i3').value, desc: document.getElementById('i4').value };
            if(modalType === 'courses') obj = { title: i1, desc: document.getElementById('i2').value, mode: document.getElementById('i3').value, link: document.getElementById('i4').value, image: document.getElementById('i5').value, cost: document.getElementById('i6').value, paymentUrl: document.getElementById('i7').value };
            if(modalType === 'placement') obj = { role: i1, company: document.getElementById('i2').value, pay: document.getElementById('i3').value, image: document.getElementById('i4').value };
            if(modalType === 'events') obj = { name: i1, date: document.getElementById('i2').value.replace('T', ' '), location: document.getElementById('i3').value, image: document.getElementById('i4').value, limit: parseInt(document.getElementById('i5').value) || 100, desc: document.getElementById('i6').value, count: 0 };

            try {
                if(editingId) {
                    if(modalType === 'events') delete obj.count;
                    await updateDoc(doc(db, modalType, editingId), obj);
                    Toastify({text: "Updated!", style: {background: "#3b82f6"}}).showToast();
                } else {
                    await addDoc(collection(db, modalType), obj);
                    Toastify({text: "Saved!", style: {background: "#10b981"}}).showToast();
                }
                document.getElementById('data-modal').classList.add('hidden');
                renderCollection(modalType);
            } catch(e) { console.error(e); }
        });

        window.navTo = (id) => {
            if(document.body.classList.contains('scanner-mode')) return; // Block navigation for scanners
            document.getElementById('mobile-menu').classList.add('hidden');
            document.querySelectorAll('.section-view').forEach(e => e.classList.remove('active'));
            const target = document.getElementById(id);
            if(target) target.classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('bg-white/5', 'text-white'));
            const navBtn = document.getElementById(`nav-${id}`);
            if(navBtn) navBtn.classList.add('bg-white/5', 'text-white');

            const titles = { 'home': 'Dashboard', 'resources': 'Library', 'courses': 'Course Training', 'placement': 'Placement', 'events': 'Events/Seminars', 'profile': 'My Profile', 'activity': 'My Activity' };
            document.getElementById('header-title').innerText = titles[id] || 'Dashboard';
            document.getElementById('header-subtitle').classList.toggle('hidden', id !== 'home');

            const actionBox = document.getElementById('header-action');
            actionBox.innerHTML = ''; 

            if (currentUser && currentUser.role === 'admin') {
                const btnClass = "bg-blue-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition-all flex items-center gap-2 transform active:scale-95";
                let btnHtml = '';
                if(id === 'home' || id === 'events') {
                    btnHtml += `<button onclick="startScanner()" class="mr-2 bg-slate-900 text-white px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-slate-800 shadow-lg flex items-center gap-2"><i data-lucide="scan" class="w-4 h-4"></i> Scan QR</button>`;
                }

                if(id === 'resources') btnHtml = `<button onclick="openModal('resources')" class="${btnClass}"><i data-lucide="plus" class="w-4 h-4"></i> Add Resource</button>`;
                if(id === 'courses') btnHtml = `<button onclick="openModal('courses')" class="${btnClass}"><i data-lucide="plus" class="w-4 h-4"></i> Add Course Training</button>`;
                if(id === 'placement') btnHtml = `<button onclick="openModal('placement')" class="${btnClass}"><i data-lucide="briefcase" class="w-4 h-4"></i> Post Job</button>`;
                if(id === 'events') btnHtml += `<button onclick="openModal('events')" class="${btnClass}"><i data-lucide="calendar-plus" class="w-4 h-4"></i> Create Event</button>`;
                
                actionBox.innerHTML = btnHtml;
                lucide.createIcons();
            }
        };

        window.togglePassword = (id, btn) => { const i = document.getElementById(id); if(i.type==='password'){i.type='text';btn.innerHTML='<i data-lucide="eye-off" class="w-5 h-5"></i>'}else{i.type='password';btn.innerHTML='<i data-lucide="eye" class="w-5 h-5"></i>'} lucide.createIcons(); };
        window.handleFileUpload = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const res = e.target.result;
                    if(modalType === 'resources') document.getElementById('i3').value = res;
                    else if(modalType === 'courses') document.getElementById('i5').value = res;
                    else if(modalType === 'placement') document.getElementById('i4').value = res;
                    else if(modalType === 'events') document.getElementById('i4').value = res;
                };
                reader.readAsDataURL(input.files[0]);
            }
        };
        window.openResume = () => document.getElementById('resume-view').classList.remove('hidden');
        window.downloadPDF = () => { const el = document.getElementById('resume-paper'); html2canvas(el, {scale:2}).then(c => { const pdf = new jspdf.jsPDF('p', 'mm', 'a4'); pdf.addImage(c.toDataURL('image/jpeg'), 'JPEG', 0, 0, 210, 297); pdf.save('Resume.pdf'); }); };
        window.toggleMobileMenu = () => { 
            if(document.body.classList.contains('scanner-mode')) return; // Block mobile menu for scanners
            document.getElementById('mobile-menu').classList.toggle('hidden');
        };
        window.loadPhoto = (i) => { if(i.files[0]) { const r=new FileReader(); r.onload=e=>{document.getElementById('res-img').src=e.target.result;document.getElementById('res-img').classList.remove('hidden');}; r.readAsDataURL(i.files[0]); } };
        lucide.createIcons();

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => {
                        console.log('âœ“ Service Worker registered successfully');
                        // Check for updates periodically
                        setInterval(() => reg.update(), 60000);
                    })
                    .catch(err => {
                        console.log('Service Worker registration failed:', err);
                    });
            });
            
            // Handle service worker updates
            let swRefreshTimer;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (swRefreshTimer) clearTimeout(swRefreshTimer);
                swRefreshTimer = setTimeout(() => {
                    Toastify({
                        text: "App updated! Refresh to see changes.",
                        style: { background: "#10b981" },
                        duration: 5000
                    }).showToast();
                }, 100);
            });
        }
        
        // ========== NEW MODAL FUNCTIONS ==========
        let currentPlacementId = null;
        let currentCourseId = null;
        let currentEventId = null;
        
        // PLACEMENT APPLICATION MODAL
        window.openPlacementModal = (id, role, company, pay) => {
            currentPlacementId = id;
            document.getElementById('placement-role-info').innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-bold text-slate-900">${role}</h4>
                        <p class="text-sm text-slate-600">${company}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-slate-500">Monthly Pay</p>
                        <p class="font-bold text-slate-900">${pay}</p>
                    </div>
                </div>
            `;
            document.getElementById('pa-name').value = currentUser.name || '';
            document.getElementById('pa-email').value = currentUser.email || '';
            document.getElementById('placement-apply-modal').classList.remove('hidden');
            lucide.createIcons();
        };
        
        window.closePlacementModal = () => {
            document.getElementById('placement-apply-modal').classList.add('hidden');
            currentPlacementId = null;
        };
        
        window.submitPlacementApplication = async (e) => {
            e.preventDefault();
            if (!currentPlacementId) return;
            
            const appData = {
                placementId: currentPlacementId,
                uid: currentUser.uid,
                studentName: document.getElementById('pa-name').value,
                studentId: currentUser.email.split('@')[0],
                email: document.getElementById('pa-email').value,
                phone: document.getElementById('pa-phone').value,
                resumeLink: document.getElementById('pa-resume').value,
                coverLetter: document.getElementById('pa-letter').value,
                expectedSalary: document.getElementById('pa-salary').value || 'Negotiable',
                linkedinUrl: document.getElementById('pa-linkedin').value,
                appliedAt: new Date().toISOString(),
                status: 'pending'
            };
            
            try {
                await addDoc(collection(db, "placement_applications"), appData);
                Toastify({text: "Application submitted! HR will contact you soon.", style: {background: "#10b981"}}).showToast();
                closePlacementModal();
                document.querySelector('form').reset();
            } catch (error) {
                Toastify({text: "Error submitting application: " + error.message, style: {background: "#ef4444"}}).showToast();
            }
        };
        
        // PROFILE EDIT MODAL
        window.openProfileModal = () => {
            document.getElementById('prof-edit-name').value = currentUser.name || '';
            document.getElementById('prof-edit-dept').value = currentUser.dept || '';
            document.getElementById('prof-edit-year').value = currentUser.year || '';
            document.getElementById('prof-edit-phone').value = currentUser.phone || '';
            document.getElementById('prof-edit-bio').value = currentUser.bio || '';
            document.getElementById('prof-edit-linkedin').value = currentUser.linkedin || '';
            document.getElementById('profile-edit-modal').classList.remove('hidden');
        };
        
        window.closeProfileModal = () => {
            document.getElementById('profile-edit-modal').classList.add('hidden');
        };
        
        window.submitProfileUpdate = async (e) => {
            e.preventDefault();
            const userRef = doc(db, "users", currentUser.uid);
            const updates = {
                name: document.getElementById('prof-edit-name').value,
                dept: document.getElementById('prof-edit-dept').value,
                year: document.getElementById('prof-edit-year').value,
                phone: document.getElementById('prof-edit-phone').value,
                bio: document.getElementById('prof-edit-bio').value,
                linkedin: document.getElementById('prof-edit-linkedin').value
            };
            
            try {
                await updateDoc(userRef, updates);
                currentUser = { ...currentUser, ...updates };
                document.getElementById('sb-name').innerText = updates.name;
                document.getElementById('home-name').innerText = updates.name;
                document.getElementById('prof-name').innerText = updates.name;
                document.getElementById('prof-meta').innerText = `${updates.dept} â€¢ ${updates.year}`;
                document.getElementById('prof-bio').innerText = updates.bio;
                Toastify({text: "Profile updated successfully!", style: {background: "#10b981"}}).showToast();
                closeProfileModal();
            } catch (error) {
                Toastify({text: "Error updating profile: " + error.message, style: {background: "#ef4444"}}).showToast();
            }
        };
        
        // COURSE ENROLLMENT MODAL
        window.openCourseModal = (id, title, desc, link, cost) => {
            currentCourseId = id;
            currentCourseLink = link;
            document.getElementById('cd-title').innerText = title;
            document.getElementById('cd-desc').innerText = desc;
            document.getElementById('cd-cost').innerText = cost === 'Paid' ? 'Paid' : 'Free';
            document.getElementById('cd-prerequisites').innerHTML = `
                <li>Active internet connection</li>
                <li>Basic programming knowledge (for advanced courses)</li>
                <li>Dedicated study time</li>
            `;
            document.getElementById('cd-objectives').innerHTML = `
                <li>Master core concepts and practical skills</li>
                <li>Build real-world projects</li>
                <li>Earn a completion certificate</li>
            `;
            document.getElementById('course-enroll-modal').classList.remove('hidden');
            lucide.createIcons();
        };
        
        window.closeCourseModal = () => {
            document.getElementById('course-enroll-modal').classList.add('hidden');
            currentCourseId = null;
        };
        
        let currentCourseLink = '';
        window.enrollFromModal = () => {
            if (currentCourseId) window.startCourse(currentCourseId, currentCourseLink);
            closeCourseModal();
        };
        
        // EVENT REGISTRATION MODAL
        window.openEventModal = (id, name, date, location, desc, image, count, limit) => {
            currentEventId = id;
            document.getElementById('ed-name').innerText = name;
            document.getElementById('ed-date').innerText = date;
            document.getElementById('ed-location').innerText = location || 'Campus';
            document.getElementById('ed-description').innerText = desc || 'Join us for an amazing event!';
            document.getElementById('ed-capacity').innerText = `${count}/${limit} Registered`;
            if (image) {
                document.getElementById('ed-image').innerHTML = `<img src="${image}" class="w-full h-full object-cover">`;
            } else {
                document.getElementById('ed-image').innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gradient-to-r from-blue-500 to-purple-600 text-white text-3xl font-bold">ðŸ“… Event</div>`;
            }
            document.getElementById('event-register-modal').classList.remove('hidden');
            lucide.createIcons();
        };
        
        window.closeEventModal = () => {
            document.getElementById('event-register-modal').classList.add('hidden');
            currentEventId = null;
        };
        
        window.submitEventRegistration = async (e) => {
            e.preventDefault();
            if (!currentEventId) return;
            
            const eventItem = window.appData.events.find(ev => ev.id === currentEventId);
            if (!eventItem) return;
            
            const q = query(collection(db, "event_registrations"), where("eventId", "==", currentEventId), where("uid", "==", currentUser.uid));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                Toastify({text: "You are already registered for this event.", style: {background: "#ef4444"}}).showToast();
                return;
            }
            
            try {
                const eventRef = doc(db, "events", currentEventId);
                await updateDoc(eventRef, { count: increment(1) });
                const studentID = currentUser.email.split('@')[0];
                await addDoc(collection(db, "event_registrations"), {
                    eventId: currentEventId,
                    eventName: eventItem.name,
                    uid: currentUser.uid,
                    studentName: currentUser.name,
                    studentId: studentID,
                    dept: currentUser.dept || "N/A",
                    year: currentUser.year || "N/A",
                    dietaryPreference: document.getElementById('ed-dietary').value,
                    specialRequirements: document.getElementById('ed-special').value,
                    timestamp: new Date().toISOString()
                });
                
                Toastify({text: "Registered successfully!", style: {background: "#10b981"}}).showToast();
                renderCollection("events");
                window.showTicket(currentEventId, eventItem.name);
                closeEventModal();
            } catch (error) {
                Toastify({text: "Error registering: " + error.message, style: {background: "#ef4444"}}).showToast();
            }
        };
        
        // SUPPORT FORM MODAL
        window.openSupportModal = () => {
            document.getElementById('support-modal').classList.remove('hidden');
        };
        
        window.closeSupportModal = () => {
            document.getElementById('support-modal').classList.add('hidden');
        };
        
        window.submitSupportQuery = async (e) => {
            e.preventDefault();
            const supportData = {
                uid: currentUser.uid,
                studentName: currentUser.name,
                studentId: currentUser.email.split('@')[0],
                type: document.getElementById('support-type').value,
                subject: document.getElementById('support-subject').value,
                message: document.getElementById('support-message').value,
                contactMethod: document.getElementById('support-contact').value,
                status: 'open',
                createdAt: new Date().toISOString()
            };
            
            try {
                await addDoc(collection(db, "support_tickets"), supportData);
                Toastify({text: "Support ticket created! We'll get back to you soon.", style: {background: "#10b981"}}).showToast();
                closeSupportModal();
                document.querySelector('#support-modal form').reset();
            } catch (error) {
                Toastify({text: "Error creating ticket: " + error.message, style: {background: "#ef4444"}}).showToast();
            }
        };
        
        // ADMIN STATISTICS MODAL
        window.openStatsModal = async () => {
            try {
                // Count students
                const usersSnap = await getDocs(collection(db, "users"));
                const studentCount = usersSnap.docs.filter(d => d.data().role !== 'admin').length;
                
                // Count enrollments
                const enrollSnap = await getDocs(collection(db, "course_enrollments"));
                
                // Count registrations
                const regSnap = await getDocs(collection(db, "event_registrations"));
                
                // Count applications
                const appSnap = await getDocs(collection(db, "placement_applications"));
                
                // Count support tickets
                const supportSnap = await getDocs(collection(db, "support_tickets"));
                
                // Count feedback
                const feedbackSnap = await getDocs(collection(db, "event_feedback"));
                
                document.getElementById('stat-students').innerText = studentCount;
                document.getElementById('stat-enrollments').innerText = enrollSnap.docs.length;
                document.getElementById('stat-registrations').innerText = regSnap.docs.length;
                document.getElementById('stat-applications').innerText = appSnap.docs.length;
                document.getElementById('stat-support-tickets').innerText = supportSnap.docs.length;
                document.getElementById('stat-feedback').innerText = feedbackSnap.docs.length;
                
                document.getElementById('admin-stats-modal').classList.remove('hidden');
                lucide.createIcons();
            } catch (error) {
                Toastify({text: "Error loading statistics: " + error.message, style: {background: "#ef4444"}}).showToast();
            }
        };
        
        window.closeStatsModal = () => {
            document.getElementById('admin-stats-modal').classList.add('hidden');
        };
        
        window.exportAllData = async (dataType) => {
            if (currentUser.role !== 'admin') return;
            
            try {
                let csvContent = '';
                let fileName = '';
                
                if (dataType === 'students') {
                    const snap = await getDocs(collection(db, "users"));
                    csvContent = "Student ID,Name,Department,Year,Email\n";
                    snap.forEach(doc => {
                        const data = doc.data();
                        csvContent += `"${data.id || ''}","${data.name}","${data.dept}","${data.year}","${data.email}"\n`;
                    });
                    fileName = 'students_export.csv';
                } else if (dataType === 'applications') {
                    const snap = await getDocs(collection(db, "placement_applications"));
                    csvContent = "Student ID,Student Name,Position,Email,Phone,Status\n";
                    snap.forEach(doc => {
                        const data = doc.data();
                        csvContent += `"${data.studentId}","${data.studentName}","${data.placementId}","${data.email}","${data.phone}","${data.status}"\n`;
                    });
                    fileName = 'applications_export.csv';
                } else if (dataType === 'support') {
                    const snap = await getDocs(collection(db, "support_tickets"));
                    csvContent = "Student ID,Subject,Type,Status,Created\n";
                    snap.forEach(doc => {
                        const data = doc.data();
                        const date = new Date(data.createdAt).toLocaleDateString();
                        csvContent += `"${data.studentId}","${data.subject}","${data.type}","${data.status}","${date}"\n`;
                    });
                    fileName = 'support_tickets_export.csv';
                }
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                Toastify({text: "Data exported successfully!", style: {background: "#10b981"}}).showToast();
            } catch (error) {
                Toastify({text: "Error exporting data: " + error.message, style: {background: "#ef4444"}}).showToast();
            }
        };
        
        // EVENT FEEDBACK MODAL
        window.openEventFeedbackModal = () => {
            document.getElementById('event-feedback-modal').classList.remove('hidden');
            document.getElementById('feedback-rating').value = '0';
            document.querySelectorAll('.star-btn').forEach(btn => btn.style.backgroundColor = 'transparent');
        };
        
        window.closeEventFeedbackModal = () => {
            document.getElementById('event-feedback-modal').classList.add('hidden');
        };
        
        window.setRating = (value) => {
            document.getElementById('feedback-rating').value = value;
            document.querySelectorAll('.star-btn').forEach((btn, idx) => {
                btn.style.backgroundColor = idx < value ? '#fbbf24' : 'transparent';
            });
        };
        
        window.submitEventFeedback = async (e) => {
            e.preventDefault();
            const rating = parseInt(document.getElementById('feedback-rating').value);
            if (rating === 0) {
                Toastify({text: "Please rate the event", style: {background: "#ef4444"}}).showToast();
                return;
            }
            
            const feedbackData = {
                uid: currentUser.uid,
                studentName: currentUser.name,
                studentId: currentUser.email.split('@')[0],
                rating: rating,
                positive: document.getElementById('feedback-positive').value,
                improvements: document.getElementById('feedback-improve').value,
                submittedAt: new Date().toISOString()
            };
            
            try {
                await addDoc(collection(db, "event_feedback"), feedbackData);
                Toastify({text: "Thank you for your feedback!", style: {background: "#10b981"}}).showToast();
                closeEventFeedbackModal();
                document.querySelector('#event-feedback-modal form').reset();
            } catch (error) {
                Toastify({text: "Error submitting feedback: " + error.message, style: {background: "#ef4444"}}).showToast();
            }
        };
    </script>
</body>
</html>